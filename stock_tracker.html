<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Portfolio Tracker</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #151932;
            --bg-tertiary: #1e2442;
            --accent-primary: #00d4ff;
            --accent-secondary: #7c3aed;
            --text-primary: #ffffff;
            --text-secondary: #a0aec0;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --border-color: #2d3748;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #1a1f3a 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(ellipse at 20% 30%, rgba(0, 212, 255, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 70%, rgba(124, 58, 237, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 2px solid var(--border-color);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.5rem;
            box-shadow: 0 8px 16px rgba(0, 212, 255, 0.3);
        }
        
        .logo-text h1 {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .logo-text p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 300;
        }
        
        .proxy-settings {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: var(--bg-secondary);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        
        .proxy-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: var(--bg-tertiary);
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s;
            border: 1px solid var(--border-color);
        }
        
        .toggle-switch.active {
            background: var(--accent-primary);
        }
        
        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        
        .toggle-switch.active .toggle-slider {
            transform: translateX(24px);
        }
        
        .proxy-input {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            width: 250px;
        }
        
        .proxy-input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: var(--bg-secondary);
            padding: 0.5rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        
        .tab {
            flex: 1;
            padding: 1rem 2rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .tab:hover {
            color: var(--text-primary);
            background: rgba(0, 212, 255, 0.1);
        }
        
        .tab.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: var(--text-primary);
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .search-section {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }
        
        .search-bar {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .search-input {
            flex: 1;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            padding: 1rem 1.5rem;
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }
        
        .quantity-input {
            width: 120px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            padding: 1rem;
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
        }
        
        .btn {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            border-radius: 10px;
            color: var(--text-primary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 212, 255, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        .btn-danger:hover {
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
        }
        
        .table-container {
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: var(--bg-tertiary);
        }
        
        th {
            padding: 1.5rem 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }
        
        tbody tr {
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s;
        }
        
        tbody tr:hover {
            background: rgba(0, 212, 255, 0.05);
        }
        
        td {
            padding: 1.5rem 1rem;
            font-size: 0.95rem;
        }
        
        .company-name {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .stock-symbol {
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .price {
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
        }
        
        .change-positive {
            color: var(--success);
            font-weight: 600;
        }
        
        .change-negative {
            color: var(--danger);
            font-weight: 600;
        }
        
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.3rem 0.8rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .badge-success {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }
        
        .badge-danger {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }
        
        .portfolio-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--accent-primary), var(--accent-secondary));
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
        }
        
        .chart-container {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 600px;
        }
        
        #portfolioChart {
            max-width: 700px;
            max-height: 700px;
        }
        
        .announcement-item {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin-bottom: 1rem;
            transition: all 0.3s;
        }
        
        .announcement-item:hover {
            border-color: var(--accent-primary);
            transform: translateX(5px);
        }
        
        .announcement-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }
        
        .announcement-company {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.1rem;
        }
        
        .announcement-date {
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .announcement-title {
            color: var(--text-secondary);
            font-size: 0.95rem;
            line-height: 1.6;
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 212, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-primary);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from { transform: translateX(120%); opacity: 0; }
            to   { transform: translateX(0);    opacity: 1; }
        }

        /* â”€â”€ Deep Dive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .deepdive-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 1.5rem;
            height: calc(100vh - 260px);
            min-height: 600px;
        }
        .deepdive-sidebar {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
        }
        .deepdive-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.2rem;
        }
        .deepdive-label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 0.7rem;
        }
        .deepdive-select {
            width: 100%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            padding: 0.7rem 1rem;
            font-size: 0.95rem;
            font-family: inherit;
            cursor: pointer;
            outline: none;
        }
        .deepdive-select:focus { border-color: var(--accent-primary); }

        .deepdive-sources { display: flex; flex-direction: column; gap: 0.5rem; }
        .dd-source-item {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.6rem 0.8rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.82rem;
            transition: border-color 0.2s;
        }
        .dd-source-item.loaded { border-color: #10b981; }
        .dd-source-item.error  { border-color: #ef4444; opacity: 0.6; }
        .dd-source-item .dd-source-icon { font-size: 1rem; flex-shrink: 0; }
        .dd-source-item .dd-source-name { color: var(--text-primary); flex: 1; line-height: 1.3; }
        .dd-source-item .dd-source-badge {
            font-size: 0.7rem;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-weight: 600;
            flex-shrink: 0;
        }
        .dd-source-item.loaded .dd-source-badge { background: #10b98122; color: #10b981; }
        .dd-source-item.error  .dd-source-badge { background: #ef444422; color: #ef4444; }
        .dd-source-item.loading .dd-source-badge { background: var(--bg-secondary); color: var(--text-secondary); }

        .dd-context-stats {
            font-size: 0.82rem;
            color: var(--text-secondary);
            line-height: 1.8;
        }
        .dd-context-stats span { color: var(--accent-primary); font-weight: 600; }

        /* Chat area */
        .deepdive-chat {
            display: flex;
            flex-direction: column;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }
        .deepdive-chat-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .deepdive-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .dd-welcome {
            margin: auto;
            text-align: center;
            max-width: 500px;
            padding: 2rem;
        }
        .dd-suggestions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 1.2rem;
            text-align: left;
        }
        .dd-suggestion {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.6rem 0.8rem;
            font-size: 0.82rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            line-height: 1.4;
        }
        .dd-suggestion:hover {
            border-color: var(--accent-primary);
            color: var(--text-primary);
            background: rgba(0,212,255,0.05);
        }
        .dd-message {
            display: flex;
            gap: 0.8rem;
            animation: fadeIn 0.3s ease;
        }
        .dd-message.user { flex-direction: row-reverse; }
        .dd-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        .dd-message.user .dd-avatar { background: var(--accent-primary); color: #000; }
        .dd-message.ai .dd-avatar   { background: var(--bg-tertiary); border: 1px solid var(--border-color); }
        .dd-bubble {
            max-width: 75%;
            padding: 0.9rem 1.1rem;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        .dd-message.user .dd-bubble {
            background: var(--accent-primary);
            color: #000;
            border-bottom-right-radius: 4px;
        }
        .dd-message.ai .dd-bubble {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
            border: 1px solid var(--border-color);
        }
        .dd-bubble p { margin: 0 0 0.5rem; }
        .dd-bubble p:last-child { margin: 0; }
        .dd-bubble strong { color: var(--accent-primary); }
        .dd-bubble ul { margin: 0.3rem 0; padding-left: 1.2rem; }
        .dd-bubble li { margin: 0.2rem 0; }
        .dd-typing {
            display: flex;
            gap: 4px;
            align-items: center;
            padding: 0.5rem 0;
        }
        .dd-typing span {
            width: 7px; height: 7px;
            background: var(--accent-primary);
            border-radius: 50%;
            animation: ddBounce 1.2s infinite;
        }
        .dd-typing span:nth-child(2) { animation-delay: 0.2s; }
        .dd-typing span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes ddBounce {
            0%,60%,100% { transform: translateY(0); }
            30% { transform: translateY(-6px); }
        }
        .deepdive-input-area {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 0.8rem;
            align-items: flex-end;
            background: var(--bg-tertiary);
        }
        .deepdive-textarea {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            padding: 0.8rem 1rem;
            font-size: 0.95rem;
            font-family: inherit;
            resize: none;
            min-height: 44px;
            max-height: 120px;
            outline: none;
            line-height: 1.5;
        }
        .deepdive-textarea:focus { border-color: var(--accent-primary); }
        .dd-send-btn {
            width: 44px; height: 44px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            border-radius: 10px;
            color: #000;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .dd-send-btn:hover { transform: scale(1.05); }
        .dd-send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .dd-loading { color: var(--text-secondary); font-size: 0.85rem; padding: 0.5rem 0; }

        /* Streaming cursor effect */
        .dd-streaming-bubble::after {
            content: 'â–‹';
            display: inline-block;
            color: var(--accent-primary);
            animation: ddBlink 0.7s infinite;
            margin-left: 2px;
            font-size: 0.85em;
        }
        @keyframes ddBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        .dd-view-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 0.15rem 0.35rem;
            font-size: 0.85rem;
            cursor: pointer;
            text-decoration: none;
            transition: border-color 0.2s;
            display: inline-flex;
            align-items: center;
        }
        .dd-view-btn:hover { border-color: var(--accent-primary); }

        .dd-expand-btn {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 0.1rem 0.35rem;
            font-size: 0.75rem;
            cursor: pointer;
            color: var(--accent-primary);
            transition: border-color 0.2s;
        }
        .dd-expand-btn:hover { border-color: var(--accent-primary); }

        /* Detached floating chat panel */
        /* Fullscreen answer modal */
        #ddFullscreenModal {
            display: none;
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            z-index: 9999;
            flex-direction: column;
        }
        #ddFullscreenModal.active { display: flex; }
        .dd-fs-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 0.9rem 1.5rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .dd-fs-title {
            font-weight: 700; font-size: 1.1rem; color: var(--text-primary);
            display: flex; align-items: center; gap: 0.5rem;
        }
        .dd-fs-actions { display: flex; gap: 0.6rem; align-items: center; }
        .dd-fs-btn {
            background: var(--bg-tertiary); border: 1px solid var(--border-color);
            border-radius: 8px; color: var(--text-primary);
            padding: 0.4rem 1rem; font-size: 0.85rem; cursor: pointer;
            transition: background 0.15s;
        }
        .dd-fs-btn:hover { background: var(--border-color); }
        .dd-fs-close {
            background: none; border: none; color: var(--text-secondary);
            font-size: 1.5rem; cursor: pointer; padding: 0 0.3rem; line-height: 1;
            transition: color 0.15s;
        }
        .dd-fs-close:hover { color: var(--text-primary); }
        #ddFsMessages {
            flex: 1; overflow-y: auto;
            padding: 1.5rem 2rem;
            display: flex; flex-direction: column; gap: 1rem;
            max-width: 900px; width: 100%; margin: 0 auto;
            box-sizing: border-box;
        }
        #ddFsMessages .dd-message { max-width: 100%; }
        .dd-fs-input-wrap {
            border-top: 1px solid var(--border-color);
            padding: 1rem 2rem;
            background: var(--bg-secondary);
            flex-shrink: 0;
        }
        .dd-fs-input-inner {
            display: flex; gap: 0.75rem; max-width: 900px; margin: 0 auto;
        }
        .dd-fs-input-inner textarea {
            flex: 1; background: var(--bg-tertiary); border: 1px solid var(--border-color);
            border-radius: 10px; color: var(--text-primary); padding: 0.7rem 1rem;
            font-size: 0.95rem; resize: none; height: 44px; font-family: inherit;
            transition: border-color 0.2s;
        }
        .dd-fs-input-inner textarea:focus { outline: none; border-color: var(--accent-primary); }
        .dd-fs-input-inner button {
            background: var(--accent-primary); border: none; border-radius: 10px;
            color: white; padding: 0 1.2rem; cursor: pointer; font-size: 1.1rem;
            transition: opacity 0.15s;
        }
        .dd-fs-input-inner button:hover { opacity: 0.85; }

        .dd-subdocs {
            margin-top: 0.4rem;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        .dd-subdoc-link {
            display: flex;
            flex-direction: column;
            padding: 0.3rem 0.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.75rem;
            color: var(--text-primary);
            transition: border-color 0.2s;
            line-height: 1.4;
        }
        .dd-subdoc-link:hover { border-color: var(--accent-primary); color: var(--accent-primary); }
        
        .update-indicator {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--bg-secondary);
            padding: 1rem 1.5rem;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 0.8rem;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            z-index: 1000;
        }
        
        .editable-quantity {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            padding: 0.5rem 0.8rem;
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            width: 80px;
            text-align: center;
        }
        
        .editable-quantity:focus {
            outline: none;
            border-color: var(--accent-primary);
        }
        
        /* Price skeleton shimmer while loading */
        @keyframes shimmer {
            0% { background-position: -200px 0; }
            100% { background-position: 200px 0; }
        }
        .price-skeleton {
            display: inline-block;
            width: 70px;
            height: 14px;
            border-radius: 4px;
            background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--border-color) 50%, var(--bg-tertiary) 75%);
            background-size: 400px 100%;
            animation: shimmer 1.2s infinite;
        }

        /* Price flash animations for live updates */
        @keyframes flashUp {
            0%   { background: rgba(16, 185, 129, 0.3); }
            100% { background: transparent; }
        }
        @keyframes flashDown {
            0%   { background: rgba(239, 68, 68, 0.3); }
            100% { background: transparent; }
        }
        .price-flash-up   { animation: flashUp   0.8s ease-out; }
        .price-flash-down { animation: flashDown 0.8s ease-out; }

        /* Hamburger + mobile nav - hidden on desktop by default */
        .hamburger-btn,
        .mobile-header-row,
        .mobile-nav,
        .mobile-nav-overlay,
        .mobile-nav-footer { display: none !important; }

        @media (max-width: 768px) {
            .hamburger-btn,
            .mobile-header-row { display: flex !important; }
            .mobile-nav { display: flex !important; flex-direction: column; }
            .container { padding: 0.75rem; }

            /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
            .header {
                flex-direction: column;
                gap: 0.6rem;
                margin-bottom: 1rem;
                padding-bottom: 1rem;
            }
            .logo { gap: 0.6rem; }
            .logo-icon { width: 38px; height: 38px; font-size: 1.1rem; border-radius: 10px; }
            .logo-text h1 { font-size: 1.2rem; }
            .logo-text p { font-size: 0.78rem; }

            /* â”€â”€ Proxy settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
            .proxy-settings {
                flex-direction: column;
                gap: 0.6rem;
                padding: 0.75rem;
                border-radius: 10px;
            }
            .proxy-toggle { justify-content: space-between; }
            .proxy-input { width: 100%; font-size: 0.85rem; }

            /* â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
            .tabs {
                padding: 0.3rem;
                gap: 0.25rem;
                overflow-x: auto;
                flex-wrap: nowrap;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                margin-bottom: 1rem;
                border-radius: 10px;
            }
            .tabs::-webkit-scrollbar { display: none; }
            .tab {
                padding: 0.65rem 0.9rem;
                font-size: 0.78rem;
                white-space: nowrap;
                flex: 0 0 auto;
                border-radius: 7px;
            }

            /* â”€â”€ WATCHLIST TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
            .search-section {
                padding: 0.9rem;
                margin-bottom: 0.75rem;
                border-radius: 10px;
            }
            .search-bar { flex-direction: column; gap: 0.6rem; }
            .search-input {
                font-size: 0.92rem;
                padding: 0.75rem 1rem;
                border-radius: 8px;
            }
            .btn {
                width: 100%;
                padding: 0.8rem;
                font-size: 0.92rem;
                border-radius: 8px;
                text-align: center;
            }
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                border-radius: 10px;
            }
            table { font-size: 0.8rem; min-width: 520px; }
            th { padding: 0.7rem 0.6rem; font-size: 0.72rem; letter-spacing: 0.3px; }
            td { padding: 0.7rem 0.6rem; }
            .company-name { font-size: 0.85rem; line-height: 1.3; }
            .stock-symbol { font-size: 0.72rem; }
            .price { font-size: 0.85rem; }
            .change-positive, .change-negative { font-size: 0.82rem; }
            .badge { font-size: 0.72rem; padding: 0.2rem 0.45rem; border-radius: 5px; }
            .btn-danger { padding: 0.35rem 0.6rem; font-size: 0.75rem; width: auto; border-radius: 6px; }

            /* â”€â”€ PORTFOLIO TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
            .portfolio-stats {
                grid-template-columns: 1fr 1fr;
                gap: 0.6rem;
                margin-bottom: 0.75rem;
            }
            .stat-card { padding: 0.9rem 0.75rem; border-radius: 10px; }
            .stat-card::before { width: 3px; }
            .stat-label { font-size: 0.72rem; margin-bottom: 0.3rem; }
            .stat-value { font-size: 1.2rem; }
            .editable-quantity { width: 58px; padding: 0.35rem; font-size: 0.78rem; }
            .quantity-input { width: 100%; border-radius: 8px; }
            .chart-container {
                padding: 0.75rem;
                min-height: 260px;
                margin-bottom: 0.75rem;
                border-radius: 10px;
            }
            #portfolioChart { max-width: 260px !important; max-height: 260px !important; }

            /* â”€â”€ ANNOUNCEMENTS TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
            .announcement-item {
                padding: 0.9rem;
                margin-bottom: 0.6rem;
                border-radius: 10px;
                transform: none !important;
                transition: border-color 0.2s;
            }
            .announcement-header {
                flex-direction: column;
                gap: 0.3rem;
                margin-bottom: 0.6rem;
                align-items: flex-start;
            }
            .announcement-company { font-size: 0.92rem; }
            .announcement-date {
                font-size: 0.75rem;
                background: var(--bg-tertiary);
                padding: 0.2rem 0.5rem;
                border-radius: 4px;
            }
            .announcement-title { font-size: 0.85rem; line-height: 1.55; }

            /* â”€â”€ EMPTY STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
            .empty-state { padding: 2.5rem 1rem; }
            .empty-state-icon { font-size: 2.8rem; margin-bottom: 0.7rem; }
            .empty-state p { font-size: 0.88rem; line-height: 1.5; }

            /* Deep Dive - fully optimized for mobile */
            .deepdive-layout {
                grid-template-columns: 1fr;
                height: auto;
                min-height: unset;
                gap: 0.75rem;
            }

            /* Sidebar becomes a compact collapsible panel */
            .deepdive-sidebar {
                overflow: hidden;
                max-height: none;
            }
            .deepdive-section {
                padding: 0.9rem;
                border-radius: 10px;
            }
            .deepdive-label {
                font-size: 0.75rem;
                margin-bottom: 0.5rem;
            }
            .deepdive-select {
                padding: 0.6rem 0.8rem;
                font-size: 0.9rem;
            }

            /* Source items more compact */
            .dd-source-item {
                padding: 0.5rem 0.7rem;
                font-size: 0.78rem;
            }
            .dd-context-stats {
                font-size: 0.78rem;
                line-height: 1.6;
            }

            /* Chat takes most of the screen */
            .deepdive-chat {
                height: 65vh;
                min-height: 420px;
                border-radius: 10px;
            }
            .deepdive-chat-header {
                padding: 0.7rem 1rem;
                flex-wrap: wrap;
                gap: 0.4rem;
            }
            .deepdive-chat-header > div:first-child {
                font-size: 0.9rem;
                flex: 1;
                min-width: 0;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            #ddChatStatus {
                font-size: 0.72rem !important;
            }
            .dd-expand-btn {
                font-size: 0.7rem;
                padding: 0.15rem 0.4rem;
            }

            /* Messages area */
            .deepdive-messages {
                padding: 1rem;
                gap: 0.75rem;
            }

            /* Welcome screen */
            .dd-welcome {
                padding: 1rem;
            }
            .dd-welcome > div:first-child {
                font-size: 2rem !important;
                margin-bottom: 0.5rem !important;
            }
            .dd-welcome > div:nth-child(2) {
                font-size: 1rem !important;
            }
            .dd-welcome > div:nth-child(3) {
                font-size: 0.85rem !important;
            }

            /* Suggestions - 1 column, scrollable */
            .dd-suggestions {
                grid-template-columns: 1fr;
                gap: 0.4rem;
                margin-top: 0.8rem;
                max-height: 200px;
                overflow-y: auto;
            }
            .dd-suggestion {
                padding: 0.5rem 0.7rem;
                font-size: 0.8rem;
            }

            /* Chat bubbles */
            .dd-bubble {
                max-width: 88%;
                font-size: 0.85rem;
                padding: 0.75rem 0.9rem;
                line-height: 1.5;
            }
            .dd-avatar {
                width: 28px !important;
                height: 28px !important;
                font-size: 0.8rem !important;
            }

            /* Input area - bigger tap targets */
            .deepdive-input-area {
                padding: 0.6rem 0.75rem;
                gap: 0.6rem;
            }
            .deepdive-textarea {
                font-size: 0.9rem;
                padding: 0.65rem 0.8rem;
                min-height: 42px;
            }
            .dd-send-btn {
                width: 42px;
                height: 42px;
                font-size: 1rem;
                border-radius: 8px;
            }

            /* Fullscreen modal - better on mobile */
            #ddFullscreenModal { overflow: hidden; }
            .dd-fs-header { padding: 0.7rem 1rem; }
            .dd-fs-title { font-size: 0.95rem !important; }
            .dd-fs-btn { padding: 0.3rem 0.7rem; font-size: 0.78rem; }
            #ddFsMessages { padding: 0.75rem 1rem; gap: 0.75rem; }
            .dd-fs-input-wrap { padding: 0.6rem 1rem; }
            .dd-fs-input-inner textarea { font-size: 0.9rem; }
            .dd-fs-input-inner button { padding: 0 1rem; font-size: 1rem; }

            /* Update indicator */
            .update-indicator {
                bottom: 1rem;
                right: 1rem;
                left: 1rem;
                font-size: 0.85rem;
                padding: 0.75rem 1rem;
            }

            /* Empty state */
            .empty-state { padding: 2rem 1rem; }
            .empty-state-icon { font-size: 2.5rem; }

            /* â”€â”€ HAMBURGER MENU (mobile only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
            .hamburger-btn {
                display: flex;
                flex-direction: column;
                justify-content: center;
                gap: 5px;
                width: 38px;
                height: 38px;
                background: var(--bg-secondary);
                border: 1px solid var(--border-color);
                border-radius: 10px;
                cursor: pointer;
                padding: 8px;
                flex-shrink: 0;
                transition: background 0.2s;
                position: relative;
                z-index: 10000;
            }
            .hamburger-btn:active { background: var(--bg-tertiary); }
            .hamburger-btn span {
                display: block;
                height: 2px;
                background: var(--text-primary);
                border-radius: 2px;
                transition: all 0.3s;
            }
            .hamburger-btn.open span:nth-child(1) {
                transform: translateY(7px) rotate(45deg);
            }
            .hamburger-btn.open span:nth-child(2) {
                opacity: 0;
            }
            .hamburger-btn.open span:nth-child(3) {
                transform: translateY(-7px) rotate(-45deg);
            }

            /* Mobile header row */
            .mobile-header-row {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 0.75rem;
            }

            /* Current tab title shown in header */
            .mobile-tab-title {
                font-size: 0.95rem;
                font-weight: 600;
                color: var(--text-primary);
                flex: 1;
                text-align: center;
            }

            /* Dropdown nav menu */
            .mobile-nav {
                position: fixed;
                top: 0;
                left: 0;
                width: 75%;
                max-width: 280px;
                height: 100vh;
                background: var(--bg-secondary);
                border-right: 1px solid var(--border-color);
                z-index: 9999;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                display: flex;
                flex-direction: column;
                box-shadow: 4px 0 24px rgba(0,0,0,0.4);
            }
            .mobile-nav.open { transform: translateX(0); }

            .mobile-nav-header {
                padding: 1.5rem 1.2rem 1rem;
                border-bottom: 1px solid var(--border-color);
                display: flex;
                align-items: center;
                gap: 0.7rem;
            }
            .mobile-nav-header .logo-icon {
                width: 36px; height: 36px; font-size: 1rem;
            }
            .mobile-nav-header h2 {
                font-size: 1rem;
                font-weight: 700;
                background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }

            .mobile-nav-items {
                flex: 1;
                padding: 0.75rem 0.6rem;
                display: flex;
                flex-direction: column;
                gap: 0.3rem;
            }
            .mobile-nav-item {
                display: flex;
                align-items: center;
                gap: 0.9rem;
                padding: 0.85rem 1rem;
                border-radius: 10px;
                border: none;
                background: transparent;
                color: var(--text-secondary);
                font-size: 0.95rem;
                font-weight: 500;
                cursor: pointer;
                text-align: left;
                transition: all 0.2s;
                font-family: inherit;
            }
            .mobile-nav-item:active { background: var(--bg-tertiary); }
            .mobile-nav-item.active {
                background: linear-gradient(135deg, rgba(0,212,255,0.15), rgba(124,58,237,0.15));
                color: var(--text-primary);
                border: 1px solid rgba(0,212,255,0.2);
            }
            .mobile-nav-item .nav-icon { font-size: 1.2rem; }
            .mobile-nav-item .nav-label { font-size: 0.92rem; }

            /* User info + logout at bottom of nav */
            .mobile-nav-footer.populated {
                display: flex !important;
                flex-direction: column;
                gap: 0.6rem;
                padding: 1rem 0.8rem;
                border-top: 1px solid var(--border-color);
            }
            .mobile-nav-user {
                display: flex;
                align-items: center;
                gap: 0.7rem;
                padding: 0.7rem 0.9rem;
                background: var(--bg-tertiary);
                border-radius: 10px;
                color: var(--text-primary);
                font-size: 0.9rem;
                font-weight: 500;
            }
            .mobile-nav-logout {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 0.5rem;
                padding: 0.75rem;
                background: rgba(239,68,68,0.12);
                border: 1px solid rgba(239,68,68,0.3);
                border-radius: 10px;
                color: #ef4444;
                font-size: 0.9rem;
                font-weight: 600;
                cursor: pointer;
                font-family: inherit;
                transition: background 0.2s;
            }
            .mobile-nav-logout:active { background: rgba(239,68,68,0.25); }

            /* Overlay behind nav */
            .mobile-nav-overlay {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.55);
                z-index: 9998;
                backdrop-filter: blur(2px);
            }
            .mobile-nav-overlay.open { display: block; }

            /* Hide desktop header on mobile - replaced by mobile-header-row */
            .header { display: none; }

            /* Hide desktop tabs on mobile */
            .tabs { display: none !important; }

            /* Extra small screens (iPhone SE etc) */
        }

        @media (max-width: 380px) {
            .portfolio-stats { grid-template-columns: 1fr; }
            .stat-value { font-size: 1.1rem; }
        }
    </style>
</head>
<body>
    <!-- Mobile Nav Overlay -->
    <div class="mobile-nav-overlay" id="mobileNavOverlay" onclick="closeMobileNav()"></div>

    <!-- Mobile Slide-in Nav -->
    <div class="mobile-nav" id="mobileNav">
        <div class="mobile-nav-header">
            <div class="logo-icon">â‚¹</div>
            <h2>Stock Tracker Pro</h2>
        </div>
        <div class="mobile-nav-items">
            <button class="mobile-nav-item active" onclick="switchTabMobile(0)">
                <span class="nav-icon">ðŸ“Š</span>
                <span class="nav-label">Watchlist</span>
            </button>
            <button class="mobile-nav-item" onclick="switchTabMobile(1)">
                <span class="nav-icon">ðŸ’¼</span>
                <span class="nav-label">Portfolio</span>
            </button>
            <button class="mobile-nav-item" onclick="switchTabMobile(2)">
                <span class="nav-icon">ðŸ“¢</span>
                <span class="nav-label">Announcements</span>
            </button>
            <button class="mobile-nav-item" onclick="switchTabMobile(3)">
                <span class="nav-icon">ðŸ”¬</span>
                <span class="nav-label">Deep Dive</span>
            </button>
            <button class="mobile-nav-item" id="adminMobileNavItem" onclick="switchTabMobile(4)" style="display:none;">
                <span class="nav-icon">ðŸ‘¥</span>
                <span class="nav-label">Users</span>
            </button>
        </div>

        <!-- User info + logout at bottom of nav -->
        <div class="mobile-nav-footer" id="mobileNavFooter">
            <div class="mobile-nav-user" id="mobileNavUser"></div>
            <button class="mobile-nav-logout" onclick="logout()">
                <span>ðŸšª</span> Logout
            </button>
        </div>
    </div>

    <div class="container">
        <!-- Mobile header row (hamburger + title) -->
        <div class="mobile-header-row">
            <button class="hamburger-btn" id="hamburgerBtn" onclick="toggleMobileNav()">
                <span></span><span></span><span></span>
            </button>
            <div class="mobile-tab-title" id="mobileTabTitle">ðŸ“Š Watchlist</div>
            <div style="width:38px;"></div><!-- spacer to center title -->
        </div>

        <div class="header">
            <div class="logo">
                <div class="logo-icon">â‚¹</div>
                <div class="logo-text">
                    <h1>Stock Tracker Pro</h1>
                    <p>Real-time Portfolio Management</p>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab(0)">ðŸ“Š Watchlist</button>
            <button class="tab" onclick="switchTab(1)">ðŸ’¼ Portfolio</button>
            <button class="tab" onclick="switchTab(2)">ðŸ“¢ Announcements</button>
            <button class="tab" onclick="switchTab(3)">ðŸ”¬ Deep Dive</button>
            <button class="tab" id="adminTab" onclick="switchTab(4)" style="display:none;">ðŸ‘¥ Users</button>
        </div>

        <div class="tab-content active" id="watchlist">
            <div class="search-section">
                <div class="search-bar">
                    <input type="text" class="search-input" id="watchlistSearch" placeholder="Enter company name (e.g., Reliance, TCS, Infosys)">
                    <button class="btn" onclick="addToWatchlist()">Add to Watchlist</button>
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Company</th>
                            <th>Price (â‚¹)</th>
                            <th>Change</th>
                            <th>Volume</th>
                            <th>Action</th>
                            <th style="width:60px;text-align:center;">Order</th>
                        </tr>
                    </thead>
                    <tbody id="watchlistTable">
                        <tr>
                            <td colspan="6" class="empty-state">
                                <div class="empty-state-icon">ðŸ“ˆ</div>
                                <p>No stocks in watchlist. Add stocks to start tracking.</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-content" id="portfolio">
            <div class="portfolio-stats">
                <div class="stat-card">
                    <div class="stat-label">Total Portfolio Value</div>
                    <div class="stat-value" id="totalValue">â‚¹0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Stocks</div>
                    <div class="stat-value" id="totalStocks">0</div>
                </div>
            </div>

            <div class="search-section">
                <div class="search-bar">
                    <input type="text" class="search-input" id="portfolioSearch" placeholder="Enter company name (e.g., Reliance, TCS, Infosys)">
                    <input type="number" class="quantity-input" id="quantityInput" placeholder="Quantity" min="1" value="1">
                    <button class="btn" onclick="addToPortfolio()">Add to Portfolio</button>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="portfolioChart"></canvas>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Company</th>
                            <th>Price (â‚¹)</th>
                            <th>Quantity</th>
                            <th>Total Value (â‚¹)</th>
                            <th>% of Portfolio</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="portfolioTable">
                        <tr>
                            <td colspan="6" class="empty-state">
                                <div class="empty-state-icon">ðŸ’¼</div>
                                <p>No stocks in portfolio. Add stocks to start building your portfolio.</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-content" id="announcements">
            <div id="announcementsList">
                <div class="empty-state">
                    <div class="empty-state-icon">ðŸ“¢</div>
                    <p>No announcements available. Add stocks to your watchlist to see relevant announcements.</p>
                </div>
            </div>
        </div>

        <div class="tab-content" id="deepdive">
            <div class="deepdive-layout">
                <!-- Left Panel: Stock selector + document sources -->
                <div class="deepdive-sidebar">
                    <div class="deepdive-section">
                        <label class="deepdive-label">Select Company</label>
                        <select id="ddStockSelect" class="deepdive-select">
                            <option value="">-- Choose from watchlist --</option>
                        </select>
                    </div>

                    <div class="deepdive-section" id="ddSourcesPanel" style="display:none;">
                        <label class="deepdive-label">ðŸ“‚ Document Sources</label>
                        <div class="deepdive-sources" id="ddSources">
                            <div class="dd-loading">Fetching documents...</div>
                        </div>
                        <button class="btn" id="ddLoadBtn" onclick="loadDeepDiveDocuments()" style="width:100%;margin-top:0.8rem;font-size:0.9rem;">
                            ðŸ”„ Refresh Documents
                        </button>
                    </div>

                    <div class="deepdive-section" id="ddContextPanel" style="display:none;">
                        <label class="deepdive-label">ðŸ“Š Loaded Context</label>
                        <div id="ddContextStats" class="dd-context-stats"></div>
                    </div>
                </div>

                <!-- Right Panel: AI Chat -->
                <div class="deepdive-chat">
                    <div class="deepdive-chat-header">
                        <div id="ddChatTitle" style="font-weight:600;color:var(--text-primary);">Select a company to begin</div>
                        <div style="display:flex;align-items:center;gap:0.5rem;">
                            <div id="ddChatStatus" style="font-size:0.8rem;color:var(--text-secondary);">No documents loaded</div>
                            <button class="dd-expand-btn" onclick="detachAnswerPanel()" title="Open in full screen">â›¶ Full Screen</button>
                        </div>
                    </div>

                    <div class="deepdive-messages" id="ddMessages">
                        <div class="dd-welcome">
                            <div style="font-size:3rem;margin-bottom:1rem;">ðŸ”¬</div>
                            <div style="font-size:1.2rem;font-weight:600;color:var(--text-primary);margin-bottom:0.5rem;">Deep Dive AI Analyst</div>
                            <div style="color:var(--text-secondary);font-size:0.95rem;line-height:1.6;">
                                Select a company from your watchlist, load its annual reports and earnings transcripts, then ask anything:
                            </div>
                            <div class="dd-suggestions">
                                <div class="dd-suggestion" onclick="ddAskSuggestion(this)">What is the revenue growth trend over 5 years?</div>
                                <div class="dd-suggestion" onclick="ddAskSuggestion(this)">What are the key risks mentioned in the annual report?</div>
                                <div class="dd-suggestion" onclick="ddAskSuggestion(this)">Summarize the latest quarterly earnings call</div>
                                <div class="dd-suggestion" onclick="ddAskSuggestion(this)">What is management's guidance for next year?</div>
                                <div class="dd-suggestion" onclick="ddAskSuggestion(this)">Compare margins across the last 4 quarters</div>
                                <div class="dd-suggestion" onclick="ddAskSuggestion(this)">What are the main business segments and their performance?</div>
                            </div>
                        </div>
                    </div>

                    <div class="deepdive-input-area">
                        <textarea id="ddQuestion" class="deepdive-textarea" 
                            placeholder="Ask anything about this company's financials, strategy, risks..."
                            onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();askDeepDive();}"></textarea>
                        <button class="dd-send-btn" onclick="askDeepDive()" id="ddSendBtn">
                            <span id="ddSendIcon">âž¤</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin: Users Tab (only visible to raghunathreddy80) -->
        <div class="tab-content" id="adminUsers" style="display:none;">
            <div class="search-section" style="margin-bottom:1.5rem;">
                <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem;">
                    <div>
                        <div style="font-size:1.1rem;font-weight:600;color:var(--text-primary);">ðŸ‘¥ Registered Users</div>
                        <div style="font-size:0.85rem;color:var(--text-secondary);margin-top:0.2rem;">Manage all registered accounts</div>
                    </div>
                    <button class="btn" onclick="loadAdminUsers()" style="padding:0.7rem 1.5rem;font-size:0.9rem;">ðŸ”„ Refresh</button>
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Username</th>
                            <th>Registered</th>
                            <th>Watchlist</th>
                            <th>Portfolio</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="adminUsersTable">
                        <tr>
                            <td colspan="6" class="empty-state">
                                <div class="empty-state-icon">ðŸ‘¥</div>
                                <p>Loading users...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="update-indicator" id="updateIndicator" style="display: none;">
        <div class="loading"></div>
        <span>Updating prices...</span>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

    <script>

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // AUTHENTICATION CHECK
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        const WATCHLIST_KEY = 'stockTracker_watchlist';
        const PORTFOLIO_KEY = 'stockTracker_portfolio';
        let watchlist = [];
        let portfolio = [];
        let updateInterval;
        let chartInstance = null;

        async function init() {
            // Check if backend is running
            checkBackend();
            
            await loadFromStorage(); // Wait for data to load from database

            // Seed priceCache from DB-stored prices so table renders with real values instantly
            [...watchlist, ...portfolio].forEach(s => {
                if (s.symbol && (s.current_price || s.price) > 0) {
                    priceCache[s.symbol] = {
                        price: s.current_price || s.price || 0,
                        change: s.change || 0,
                        changePercent: s.changePercent || 0,
                        volume: s.volume || 0
                    };
                }
            });

            renderWatchlist();
            renderPortfolio();
            startAutoUpdate();

            // Kick off live price poll immediately (no delay)
            pollPrices();
        }

        async function loadFromStorage() {
            // Load watchlist from database
            try {
                const watchlistResponse = await fetch(API_URL + '/watchlist', {
                    credentials: 'include'
                });
                if (watchlistResponse.ok) {
                    watchlist = await watchlistResponse.json();
                    console.log('Loaded watchlist from database:', watchlist);
                }
            } catch (error) {
                console.error('Error loading watchlist:', error);
                watchlist = [];
            }
            
            // Load portfolio from database
            try {
                const portfolioResponse = await fetch(API_URL + '/portfolio', {
                    credentials: 'include'
                });
                if (portfolioResponse.ok) {
                    portfolio = await portfolioResponse.json();
                    console.log('Loaded portfolio from database:', portfolio);
                }
            } catch (error) {
                console.error('Error loading portfolio:', error);
                portfolio = [];
            }
        }

        function saveToStorage() {
            // No longer needed - data is saved to database via API calls
            console.log('Data auto-saved to database');
        }

        function switchTab(index) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach((tab, i) => {
                if (i === index) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            // Handle regular tabs (0-3)
            contents.forEach((content, i) => {
                if (i === index) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });

            // Handle admin tab (index 4) separately â€” it's outside .tab-content list
            const adminPanel = document.getElementById('adminUsers');
            if (adminPanel) {
                if (index === 4) {
                    // Hide all regular tab contents
                    contents.forEach(c => c.classList.remove('active'));
                    adminPanel.style.display = 'block';
                    loadAdminUsers();
                } else {
                    adminPanel.style.display = 'none';
                }
            }

            if (index === 1) updatePortfolioChart();
            if (index === 2) updateAnnouncements();
            if (index === 3) initDeepDive();
        }

        // â”€â”€ Mobile Nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const TAB_LABELS = ['ðŸ“Š Watchlist', 'ðŸ’¼ Portfolio', 'ðŸ“¢ Announcements', 'ðŸ”¬ Deep Dive', 'ðŸ‘¥ Users'];

        function toggleMobileNav() {
            const nav = document.getElementById('mobileNav');
            const overlay = document.getElementById('mobileNavOverlay');
            const btn = document.getElementById('hamburgerBtn');
            const isOpen = nav.classList.contains('open');
            nav.classList.toggle('open', !isOpen);
            overlay.classList.toggle('open', !isOpen);
            btn.classList.toggle('open', !isOpen);
        }

        function closeMobileNav() {
            document.getElementById('mobileNav').classList.remove('open');
            document.getElementById('mobileNavOverlay').classList.remove('open');
            document.getElementById('hamburgerBtn').classList.remove('open');
        }

        function switchTabMobile(index) {
            switchTab(index);
            // Update active state in mobile nav
            document.querySelectorAll('.mobile-nav-item').forEach((item, i) => {
                item.classList.toggle('active', i === index);
            });
            // Update title in header
            document.getElementById('mobileTabTitle').textContent = TAB_LABELS[index];
            closeMobileNav();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  DEEP DIVE - CLEAN & SIMPLE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let ddContext = '';
        let ddCompany = '';
        let ddSymbol = '';
        let ddChatHistory = [];
        let ddDocuments = { annual: [], concalls: [], presentations: [] };
        let ddInitialized = false;

        function initDeepDive() {
            if (ddInitialized) return;
            ddInitialized = true;
            populateDDStockSelect();
        }

        function populateDDStockSelect() {
            const sel = document.getElementById('ddStockSelect');
            sel.innerHTML = '<option value="">-- Choose from watchlist --</option>';
            watchlist.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.symbol;
                opt.textContent = s.name;
                sel.appendChild(opt);
            });
            sel.onchange = onDDStockSelected;
        }

        async function onDDStockSelected() {
            const sel = document.getElementById('ddStockSelect');
            ddSymbol = sel.value;
            ddCompany = sel.options[sel.selectedIndex]?.text || '';
            if (!ddSymbol) return;

            document.getElementById('ddSourcesPanel').style.display = 'block';
            document.getElementById('ddContextPanel').style.display = 'none';
            document.getElementById('ddChatTitle').textContent = ddCompany;
            document.getElementById('ddChatStatus').textContent = 'Loading documents...';
            
            // Disable AI input until documents are read
            document.getElementById('ddQuestion').disabled = true;
            document.getElementById('ddSendBtn').disabled = true;
            document.getElementById('ddQuestion').placeholder = 'Select documents to read first...';
            
            // Clear chat completely
            ddContext = '';
            ddChatHistory = [];
            ddDocuments = { annual: [], concalls: [], presentations: [] };
            
            // Clear visible chat messages
            const chatContainer = document.getElementById('ddMessages');
            if (chatContainer) {
                chatContainer.innerHTML = '';
            }

            await loadDeepDiveDocuments();
        }

        async function loadDeepDiveDocuments() {
            if (!ddSymbol) return;
            
            const base = ddSymbol.replace('.NS', '').replace('.BO', '');
            const sourcesDiv = document.getElementById('ddSources');
            
            // Show loading
            sourcesDiv.innerHTML = `
                <div style="text-align:center;padding:3rem;color:var(--text-secondary);">
                    <div class="loading" style="margin:0 auto 1rem;"></div>
                    <p>Fetching documents...</p>
                </div>
            `;
            
            try {
                const { host: proxyHost, port: proxyPort } = parseProxy();
                
                const resp = await fetch(`${API_URL}/deepdive/screener`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        base_symbol: base,
                        company: ddCompany,
                        proxy_host: proxyHost,
                        proxy_port: proxyPort
                    })
                });
                
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                
                const data = await resp.json();
                console.log('Deep Dive response:', data);
                
                if (data.error) throw new Error(data.error);
                
                ddDocuments.annual = data.annual_reports || [];
                ddDocuments.concalls = data.concalls || [];
                ddDocuments.presentations = data.presentations || [];
                
                // Build context for AI
                ddContext = `Company: ${ddCompany} (${base})\n\n`;
                
                if (ddDocuments.annual.length > 0) {
                    ddContext += `=== Annual Reports (${ddDocuments.annual.length}) ===\n`;
                    ddDocuments.annual.forEach(doc => {
                        ddContext += `- ${doc.title} (${doc.year}): ${doc.url}\n`;
                    });
                    ddContext += '\n';
                }
                
                if (ddDocuments.concalls.length > 0) {
                    ddContext += `=== Concall Transcripts (${ddDocuments.concalls.length}) ===\n`;
                    ddDocuments.concalls.forEach(doc => {
                        ddContext += `- ${doc.quarter} (${doc.date}): ${doc.title}\n`;
                    });
                }

                if (ddDocuments.presentations.length > 0) {
                    ddContext += `\n=== Investor Presentation ===\n`;
                    ddDocuments.presentations.forEach(doc => {
                        ddContext += `- ${doc.title} (${doc.date}): ${doc.url}\n`;
                    });
                }
                
                // Render documents
                renderDocuments(data);
                
                // Update status
                const totalDocs = ddDocuments.annual.length + ddDocuments.concalls.length + ddDocuments.presentations.length;
                document.getElementById('ddChatStatus').textContent = 
                    totalDocs > 0 ? `Fetching document content...` : 'No documents found';
                
                if (totalDocs > 0) {
                    document.getElementById('ddContextPanel').style.display = 'block';
                    document.getElementById('ddContextStats').innerHTML = `
                        Documents loaded: <span>${totalDocs}</span><br>
                        Annual Reports: <span>${ddDocuments.annual.length}</span><br>
                        Concall Transcripts: <span>${ddDocuments.concalls.length}</span><br>
                        Presentations: <span>${ddDocuments.presentations.length}</span><br>
                        Company: <span>${ddCompany}</span>
                    `;
                    
                    // Update status to tell user to select and read documents
                    document.getElementById('ddChatStatus').textContent = 'Select documents and click "Read Selected Documents"';
                    
                    // Don't auto-fetch - let user select documents first
                    ddAddSystemMessage(`Documents loaded for **${ddCompany}**. Select which documents to read below, then click "Read Selected Documents".`);
                } else {
                    ddAddSystemMessage(`Couldn't load documents for **${ddCompany}**. Try asking questions using my general knowledge.`);
                }
                
            } catch (error) {
                console.error('Deep Dive error:', error);
                sourcesDiv.innerHTML = `
                    <div style="text-align:center;padding:3rem;color:#ff6b6b;">
                        <div style="font-size:2rem;margin-bottom:1rem;">âš ï¸</div>
                        <p><strong>Error loading documents</strong></p>
                        <p style="font-size:0.9rem;color:var(--text-secondary);margin-top:0.5rem;">${error.message}</p>
                    </div>
                `;
                document.getElementById('ddChatStatus').textContent = `Error: ${error.message}`;
            }
        }

        function toggleAllDocs(type, checked) {
            document.querySelectorAll(`.${type}-checkbox`).forEach(cb => cb.checked = checked);
        }

        // â”€â”€ Deep Dive control locking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function setDDControlsLocked(locked) {
            // Lock/unlock the company dropdown
            const sel = document.getElementById('ddStockSelect');
            if (sel) sel.disabled = locked;

            // Lock/unlock every document checkbox (individual + select-all headers)
            document.querySelectorAll(
                '.annual-checkbox, .concall-checkbox, .presentation-checkbox, #selectAllAnnual, #selectAllConcall, #selectAllPresentation'
            ).forEach(cb => { cb.disabled = locked; });

            // Lock/unlock the Read button itself so it can't be double-clicked
            const readBtn = document.getElementById('ddReadBtn');
            if (readBtn) readBtn.disabled = locked;
        }

        async function fetchDocumentText() {
            try {
                const { host: proxyHost, port: proxyPort } = parseProxy();

                // â”€â”€ Lock controls while reading â”€â”€
                setDDControlsLocked(true);
                document.getElementById('ddChatStatus').textContent = 'Reading documents...';
                const docsToFetch = [];
                
                // Get selected annual reports
                document.querySelectorAll('.annual-checkbox:checked').forEach(cb => {
                    const idx = parseInt(cb.dataset.index);
                    const doc = ddDocuments.annual[idx];
                    if (doc && !doc.title.toUpperCase().includes('DRHP')) {
                        docsToFetch.push({
                            url: doc.url,
                            title: doc.title,
                            type: 'annual'
                        });
                    }
                });
                
                // Get selected concall transcripts
                document.querySelectorAll('.concall-checkbox:checked').forEach(cb => {
                    const idx = parseInt(cb.dataset.index);
                    const doc = ddDocuments.concalls[idx];
                    if (doc && !doc.title.toUpperCase().includes('REC')) {
                        docsToFetch.push({
                            url: doc.url,
                            title: doc.quarter || doc.title,
                            type: 'concall'
                        });
                    }
                });
                
                // Get selected presentations
                document.querySelectorAll('.presentation-checkbox:checked').forEach(cb => {
                    const idx = parseInt(cb.dataset.index);
                    const doc = ddDocuments.presentations[idx];
                    if (doc) {
                        docsToFetch.push({
                            url: doc.url,
                            title: doc.title,
                            type: 'presentation'
                        });
                    }
                });
                
                if (docsToFetch.length === 0) {
                    document.getElementById('ddChatStatus').textContent = 'No documents to fetch';
                    return;
                }
                
                document.getElementById('ddChatStatus').textContent = `Reading ${docsToFetch.length} documents...`;
                
                // Fetch document text
                const resp = await fetch(`${API_URL}/deepdive/fetch-docs`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        docs: docsToFetch,
                        proxy_host: proxyHost,
                        proxy_port: proxyPort
                    })
                });
                
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                
                const data = await resp.json();
                console.log('Fetched documents:', data);
                
                // Build context from document text
                ddContext = `Company: ${ddCompany}\n\n`;
                
                let successCount = 0;
                let failCount = 0;
                let failedDocs = [];
                
                data.docs.forEach(doc => {
                    if (doc.text && doc.text.length > 100) {
                        ddContext += `\n=== ${doc.title} ===\n${doc.text}\n`;
                        successCount++;
                        console.log(`âœ“ Extracted: ${doc.title} (${doc.text.length} chars)`);
                    } else {
                        failCount++;
                        failedDocs.push(`${doc.title} - ${doc.error || 'Unknown error'}`);
                        console.error(`âœ— Failed: ${doc.title}`, doc.error || 'No text extracted');
                    }
                });
                
                console.log(`\nðŸ“Š Summary: ${successCount}/${data.docs.length} documents extracted successfully`);
                if (failedDocs.length > 0) {
                    console.error('Failed documents:', failedDocs);
                }
                
                document.getElementById('ddChatStatus').textContent = 
                    `${successCount} of ${data.docs.length} documents ready - ask anything!`;
                
                // Enable AI input
                document.getElementById('ddQuestion').disabled = false;
                document.getElementById('ddSendBtn').disabled = false;
                document.getElementById('ddQuestion').placeholder = 'Ask anything about this company\'s financials, strategy, risks...';
                
                let statusMsg = `I've read **${successCount} of ${data.docs.length} documents** for **${ddCompany}**.`;
                if (failCount > 0) {
                    statusMsg += ` (${failCount} documents couldn't be processed)`;
                }
                statusMsg += ` Ask me anything about the company!`;
                
                ddAddSystemMessage(statusMsg);

                // â”€â”€ Unlock controls after reading â”€â”€
                setDDControlsLocked(false);
                
            } catch (error) {
                console.error('Fetch docs error:', error);
                document.getElementById('ddChatStatus').textContent = `Error fetching documents: ${error.message}`;
                ddAddSystemMessage(`Could not fetch document text. I can still answer questions using my general knowledge.`);
                // â”€â”€ Unlock on error too â”€â”€
                setDDControlsLocked(false);
            }
        }

        function renderDocuments(data) {
            const sourcesDiv = document.getElementById('ddSources');
            const { annual_reports = [], concalls = [], presentations = [], fallback_links = {} } = data;
            
            let html = '';
            
            // Annual Reports Section
            html += `
                <div style="margin-bottom:2rem;">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;">
                        <h3 style="margin:0;color:var(--text-primary);font-size:1.1rem;">
                            <input type="checkbox" id="selectAllAnnual" onchange="toggleAllDocs('annual', this.checked)" style="margin-right:0.5rem;">
                            ðŸ“„ Annual Reports
                        </h3>
                    </div>
            `;
            
            if (annual_reports.length > 0) {
                annual_reports.forEach((doc, idx) => {
                    const cleanTitle = (doc.title || '')
                        .replace(/\s*from\s+bse\s*/i, '')
                        .replace(/\s*from\s+nse\s*/i, '')
                        .replace(/\s*from\s+screener\s*/i, '')
                        .trim();
                    html += `
                        <div class="dd-source-item loaded" style="margin-bottom:0.5rem;">
                            <input type="checkbox" class="doc-checkbox annual-checkbox" data-type="annual" data-index="${idx}" style="margin-right:0.5rem;">
                            <span class="dd-source-icon">ðŸ“„</span>
                            <div style="flex:1;min-width:0;">
                                <div class="dd-source-name">${cleanTitle}</div>
                                <div style="font-size:0.75rem;color:var(--text-secondary);margin-top:0.2rem;">
                                    Source: ${doc.source}
                                </div>
                            </div>
                            <div style="display:flex;gap:0.3rem;align-items:center;">
                                <a href="${doc.url}" target="_blank" rel="noopener noreferrer" 
                                   class="dd-view-btn" title="Open PDF">ðŸ”—</a>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += `
                    <div style="padding:1rem;text-align:center;color:var(--text-secondary);font-size:0.9rem;
                                background:var(--bg-tertiary);border-radius:8px;">
                        No annual reports found via API
                    </div>
                `;
            }
            
            html += `</div>`;
            
            // Concall Transcripts Section
            html += `
                <div style="margin-bottom:2rem;">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;">
                        <h3 style="margin:0;color:var(--text-primary);font-size:1.1rem;">
                            <input type="checkbox" id="selectAllConcall" onchange="toggleAllDocs('concall', this.checked)" style="margin-right:0.5rem;">
                            ðŸŽ™ï¸ Earnings Call Transcripts
                        </h3>
                    </div>
            `;
            
            if (concalls.length > 0) {
                concalls.forEach((doc, idx) => {
                    // Use quarter label if available, otherwise derive from date or title
                    let label = (doc.quarter || '').trim();
                    if (!label && doc.date) {
                        // Format date as "Mon YYYY" e.g. "Feb 2026"
                        const d = new Date(doc.date);
                        if (!isNaN(d)) {
                            label = d.toLocaleDateString('en-IN', { month: 'short', year: 'numeric' });
                        } else {
                            label = doc.date;
                        }
                    }
                    if (!label) label = `Transcript ${idx + 1}`;
                    html += `
                        <div class="dd-source-item loaded" style="margin-bottom:0.5rem;">
                            <input type="checkbox" class="doc-checkbox concall-checkbox" data-type="concall" data-index="${idx}" style="margin-right:0.5rem;">
                            <span class="dd-source-icon">ðŸŽ™ï¸</span>
                            <div style="flex:1;min-width:0;">
                                <div class="dd-source-name">${label}</div>
                                <div style="font-size:0.75rem;color:var(--text-secondary);margin-top:0.2rem;">
                                    ${doc.date}
                                </div>
                            </div>
                            <div style="display:flex;gap:0.3rem;align-items:center;">
                                <a href="${doc.url}" target="_blank" rel="noopener noreferrer" 
                                   class="dd-view-btn" title="Open PDF">ðŸ”—</a>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += `
                    <div style="padding:1rem;text-align:center;color:var(--text-secondary);font-size:0.9rem;
                                background:var(--bg-tertiary);border-radius:8px;">
                        No concall transcripts found via API
                    </div>
                `;
            }
            
            html += `</div>`;

            // Investor Presentation Section
            html += `
                <div style="margin-bottom:2rem;">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;">
                        <h3 style="margin:0;color:var(--text-primary);font-size:1.1rem;">ðŸ“Š Investor Presentation</h3>
                    </div>
            `;

            if (presentations.length > 0) {
                presentations.forEach((doc, idx) => {
                    // Shorten long BSE announcement titles to a clean label
                    let presTitle = 'Investor Presentation';
                    if (doc.date) presTitle += ` â€“ ${doc.date}`;
                    html += `
                        <div class="dd-source-item loaded" style="margin-bottom:0.5rem;">
                            <input type="checkbox" class="doc-checkbox presentation-checkbox" data-type="presentation" data-index="${idx}" style="margin-right:0.5rem;">
                            <span class="dd-source-icon">ðŸ“Š</span>
                            <div style="flex:1;min-width:0;">
                                <div class="dd-source-name">${presTitle}</div>
                                <div style="font-size:0.75rem;color:var(--text-secondary);margin-top:0.2rem;">
                                    Source: ${doc.source}
                                </div>
                            </div>
                            <div style="display:flex;gap:0.3rem;align-items:center;">
                                <a href="${doc.url}" target="_blank" rel="noopener noreferrer"
                                   class="dd-view-btn" title="Open PDF">ðŸ”—</a>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += `
                    <div style="padding:1rem;text-align:center;color:var(--text-secondary);font-size:0.9rem;
                                background:var(--bg-tertiary);border-radius:8px;">
                        No investor presentation found
                    </div>
                `;
            }

            html += `</div>`;
            
            // Add "Read Selected Documents" button
            html += `
                <div style="margin-top:2rem;text-align:center;">
                    <button id="ddReadBtn" onclick="fetchDocumentText()" class="btn" style="width:100%;padding:1rem;font-size:1rem;font-weight:600;">
                        ðŸ“– Read Selected Documents
                    </button>
                </div>
            `;

            sourcesDiv.innerHTML = html;
        }

        function ddAskSuggestion(el) {
            document.getElementById('ddQuestion').value = el.textContent;
            askDeepDive();
        }

        async function askDeepDive() {
            const input = document.getElementById('ddQuestion');
            const question = input.value.trim();
            if (!question) return;

            const btn = document.getElementById('ddSendBtn');
            btn.disabled = true;
            input.value = '';

            ddAppendMessage('user', question);
            ddChatHistory.push({ role: 'user', content: question });

            const typingId = ddShowTyping();

            try {
                const { host: proxyHost, port: proxyPort } = parseProxy();

                const resp = await fetch(`${API_URL}/deepdive/ask`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question: question,
                        context: ddContext,
                        messages: ddChatHistory.slice(0, -1),
                        proxy_host: proxyHost,
                        proxy_port: proxyPort,
                        stream: true
                    })
                });

                ddRemoveTyping(typingId);

                if (!resp.ok) {
                    const errorData = await resp.json().catch(() => ({}));
                    ddAppendMessage('ai', `âš ï¸ Error: ${errorData.error || 'Unknown error'}`);
                    btn.disabled = false;
                    return;
                }

                // â”€â”€ Streaming response â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                const msgs = document.getElementById('ddMessages');
                const msgDiv = document.createElement('div');
                msgDiv.className = 'dd-message ai';
                msgDiv.innerHTML = `
                    <div class="dd-avatar">ðŸ¤–</div>
                    <div class="dd-bubble dd-streaming-bubble"></div>
                `;
                msgs.appendChild(msgDiv);
                const bubble = msgDiv.querySelector('.dd-streaming-bubble');

                const reader = resp.body.getReader();
                const decoder = new TextDecoder();
                let fullText = '';
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); // keep incomplete line

                    for (const line of lines) {
                        if (!line.startsWith('data:')) continue;
                        const raw = line.slice(5).trim();
                        if (raw === '[DONE]') break;
                        try {
                            const chunk = JSON.parse(raw);
                            if (chunk.error) {
                                bubble.innerHTML = `âš ï¸ Error: ${chunk.error}`;
                                break;
                            }
                            if (chunk.text) {
                                fullText += chunk.text;
                                bubble.innerHTML = ddFormatText(fullText);
                                msgs.scrollTop = msgs.scrollHeight;
                            }
                        } catch(e) {}
                    }
                }

                // Final render and save to history â€” remove cursor
                if (fullText) {
                    bubble.classList.remove('dd-streaming-bubble');
                    bubble.innerHTML = ddFormatText(fullText);
                    ddChatHistory.push({ role: 'assistant', content: fullText });
                }
                msgs.scrollTop = msgs.scrollHeight;

            } catch(e) {
                ddRemoveTyping(typingId);
                ddAppendMessage('ai', `âš ï¸ Connection error: ${e.message}`);
            }

            btn.disabled = false;
        }

        function ddAppendMessage(role, text) {
            const msgs = document.getElementById('ddMessages');
            const welcome = msgs.querySelector('.dd-welcome');
            if (welcome) welcome.remove();

            const div = document.createElement('div');
            div.className = `dd-message ${role}`;
            div.innerHTML = `
                <div class="dd-avatar">${role === 'user' ? 'ðŸ‘¤' : 'ðŸ¤–'}</div>
                <div class="dd-bubble">${ddFormatText(text)}</div>
            `;
            msgs.appendChild(div);
            msgs.scrollTop = msgs.scrollHeight;
        }

        function ddAddSystemMessage(text) {
            const msgs = document.getElementById('ddMessages');
            const welcome = msgs.querySelector('.dd-welcome');
            if (welcome) welcome.remove();
            const div = document.createElement('div');
            div.className = 'dd-message ai';
            div.innerHTML = `
                <div class="dd-avatar">ðŸ¤–</div>
                <div class="dd-bubble">${ddFormatText(text)}</div>
            `;
            msgs.appendChild(div);
            msgs.scrollTop = msgs.scrollHeight;
        }

        function ddShowTyping() {
            const msgs = document.getElementById('ddMessages');
            const id = 'ddtyping-' + Date.now();
            const div = document.createElement('div');
            div.className = 'dd-message ai';
            div.id = id;
            div.innerHTML = `
                <div class="dd-avatar">ðŸ¤–</div>
                <div class="dd-bubble">
                    <div class="dd-typing"><span></span><span></span><span></span></div>
                </div>
            `;
            msgs.appendChild(div);
            msgs.scrollTop = msgs.scrollHeight;
            return id;
        }

        function ddRemoveTyping(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function ddFormatText(text) {
            return text
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/^### (.+)$/gm, '<div style="font-weight:700;margin:0.5rem 0 0.2rem;color:var(--accent-primary);">$1</div>')
                .replace(/^## (.+)$/gm,  '<div style="font-weight:700;margin:0.5rem 0 0.2rem;font-size:1.05em;">$1</div>')
                .replace(/^- (.+)$/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>\n?)+/g, s => `<ul>${s}</ul>`)
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                .replace(/^(.+)$/, '<p>$1</p>');
        }

        // Backend API URL
        // Auto-detect API URL (works both locally and on Render)
        const API_URL = window.location.origin + '/api';

        // â”€â”€ Proxy helpers (no proxy needed on Render â€” always returns empty) â”€â”€
        function parseProxy() {
            const host = localStorage.getItem('proxyHost') || '';
            const port = localStorage.getItem('proxyPort') || '';
            return { host, port };
        }
        function saveProxySettings() {
            const host = document.getElementById('proxyHostInput');
            const port = document.getElementById('proxyPortInput');
            if (host) localStorage.setItem('proxyHost', host.value.trim());
            if (port) localStorage.setItem('proxyPort', port.value.trim());
        }
        function loadProxySettings() {
            const host = document.getElementById('proxyHostInput');
            const port = document.getElementById('proxyPortInput');
            if (host) host.value = localStorage.getItem('proxyHost') || '';
            if (port) port.value = localStorage.getItem('proxyPort') || '';
        }
		
		// Authentication check - redirect to login if not authenticated
    (async function() {
        try {
            const response = await fetch(API_URL + '/auth/check', { credentials: 'include' });
            // If the server returns HTML or a non-JSON response (e.g. a redirect page),
            // check Content-Type before parsing to avoid SyntaxError.
            const ct = response.headers.get('content-type') || '';
            if (!response.ok || !ct.includes('application/json')) {
                window.location.href = '/login.html';
                return;
            }
            const data = await response.json();
            // 401 means not logged in â€” redirect to login
            if (response.status === 401 || !data.authenticated) {
                window.location.href = '/login.html';
                return;
            }
            
            // Always populate mobile nav footer (CSS hides it on desktop via media query)
            const footer = document.getElementById('mobileNavFooter');
            const userEl = document.getElementById('mobileNavUser');
            if (footer && userEl) {
                userEl.innerHTML = `<span style="font-size:1.1rem;">ðŸ‘¤</span> ${data.username}`;
                footer.classList.add('populated');
            }

            // Show admin tab only for raghunathreddy80
            if (data.username === 'raghunathreddy80') {
                const adminTab = document.getElementById('adminTab');
                if (adminTab) adminTab.style.display = '';
                const adminMobileItem = document.getElementById('adminMobileNavItem');
                if (adminMobileItem) adminMobileItem.style.display = '';
            }

            const isMobile = window.innerWidth <= 768;
            if (!isMobile) {
                // Desktop: fixed top-right overlay
                const body = document.body;
                const userInfo = document.createElement('div');
                userInfo.style.cssText = 'position:fixed;top:1rem;right:1rem;display:flex;align-items:center;gap:1rem;z-index:9999;background:rgba(0,0,0,0.5);padding:0.5rem 1rem;border-radius:8px;';
                userInfo.innerHTML = `
                    <span style="color:white;font-weight:500;">ðŸ‘¤ ${data.username}</span>
                    <button onclick="logout()" style="padding:0.5rem 1rem;background:#ff4444;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:500;">
                        Logout
                    </button>
                `;
                body.insertBefore(userInfo, body.firstChild);
            }
        } catch (error) {
            console.error('Auth check failed:', error);
            window.location.href = '/login.html';
        }
    })();
    
    async function logout() {
        try {
            await fetch(API_URL + '/auth/logout', { method: 'POST', credentials: 'include' });
        } catch (error) {
            console.error('Logout error:', error);
        }
        window.location.href = '/login.html';
    }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ADMIN â€” USER MANAGEMENT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        async function loadAdminUsers() {
            const tbody = document.getElementById('adminUsersTable');
            tbody.innerHTML = `
                <tr><td colspan="6" class="empty-state">
                    <div class="loading" style="margin:0 auto 1rem;"></div>
                    <p>Loading users...</p>
                </td></tr>`;
            try {
                const resp = await fetch(API_URL + '/admin/users', { credentials: 'include' });
                if (!resp.ok) throw new Error('Not authorised or server error');
                const users = await resp.json();
                if (!users.length) {
                    tbody.innerHTML = `<tr><td colspan="6" class="empty-state">
                        <div class="empty-state-icon">ðŸ‘¥</div><p>No users found.</p>
                    </td></tr>`;
                    return;
                }
                tbody.innerHTML = users.map((u, i) => `
                    <tr>
                        <td style="color:var(--text-secondary);font-size:0.85rem;">${i + 1}</td>
                        <td>
                            <div style="display:flex;align-items:center;gap:0.6rem;">
                                <span style="font-size:1.1rem;">ðŸ‘¤</span>
                                <div>
                                    <div class="company-name">${u.username}</div>
                                    ${u.username === 'raghunathreddy80' ? '<div style="font-size:0.75rem;color:var(--accent-primary);font-weight:600;">Admin</div>' : ''}
                                </div>
                            </div>
                        </td>
                        <td style="color:var(--text-secondary);font-size:0.85rem;">${u.created_at ? new Date(u.created_at).toLocaleDateString('en-IN', {year:'numeric',month:'short',day:'numeric'}) : 'â€”'}</td>
                        <td style="color:var(--text-secondary);">${u.watchlist_count ?? 'â€”'}</td>
                        <td style="color:var(--text-secondary);">${u.portfolio_count ?? 'â€”'}</td>
                        <td>
                            ${u.username === 'raghunathreddy80'
                                ? '<span style="color:var(--text-secondary);font-size:0.8rem;">Protected</span>'
                                : `<button
                                    onclick="removeUser('${u.username}')"
                                    title="Remove user"
                                    style="background:none;border:1px solid rgba(239,68,68,0.4);border-radius:6px;color:#ef4444;cursor:pointer;padding:0.35rem 0.5rem;font-size:1.1rem;line-height:1;transition:background 0.2s,border-color 0.2s;"
                                    onmouseenter="this.style.background='rgba(239,68,68,0.15)';this.style.borderColor='#ef4444';"
                                    onmouseleave="this.style.background='none';this.style.borderColor='rgba(239,68,68,0.4)';">ðŸ—‘ï¸</button>`
                            }
                        </td>
                    </tr>`).join('');
            } catch (err) {
                tbody.innerHTML = `<tr><td colspan="6" class="empty-state">
                    <div class="empty-state-icon">âš ï¸</div>
                    <p>Failed to load users: ${err.message}</p>
                </td></tr>`;
            }
        }

        async function removeUser(username) {
            if (!confirm(`Remove user "${username}"? This will delete all their data permanently.`)) return;
            try {
                const resp = await fetch(API_URL + '/admin/users/remove', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ username })
                });
                const result = await resp.json();
                if (result.success) {
                    loadAdminUsers();
                } else {
                    alert(result.message || 'Failed to remove user');
                }
            } catch (err) {
                alert('Error removing user: ' + err.message);
            }
        }

        // Check if backend is running
        async function checkBackend() {
            try {
                const response = await fetch(`${API_URL}/health`);
                if (response.ok) {
                    console.log('âœ“ Backend server is running');
                    return true;
                }
            } catch (error) {
                console.error('âœ— Backend server is NOT running!');
                console.error('Please run: python stock_backend.py');
                return false;
            }
        }

        // Search for Indian stocks using backend API
        async function searchIndiaStocks(query) {
            try {
                console.log('Searching for:', query);
                const url = `${API_URL}/search?q=${encodeURIComponent(query)}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    console.error('Search failed with status:', response.status);
                    const errorData = await response.json();
                    console.error('Error details:', errorData);
                    alert(`Search failed: ${errorData.error || 'Unknown error'}\n\nMake sure backend is running:\npython stock_backend.py`);
                    return [];
                }
                
                const data = await response.json();
                console.log('Search results:', data.results);
                return data.results || [];
            } catch (error) {
                console.error('Search error:', error);
                alert('âŒ Cannot connect to backend server!\n\nPlease make sure the Python backend is running:\n\n1. Open terminal/command prompt\n2. Run: python stock_backend.py\n3. Wait for "Server starting on http://localhost:5000"\n4. Then try again');
                return [];
            }
        }

        // Fetch stock price using backend API
        async function fetchStockPrice(symbol) {
            try {
                console.log('Fetching price for:', symbol);
                // Try /api/quote first
                const url = `${API_URL}/quote?symbol=${encodeURIComponent(symbol)}`;
                const response = await fetch(url, { credentials: 'include' });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.price && data.price > 0) {
                        console.log('Price data:', data);
                        return { price: data.price, change: data.change,
                                 changePercent: data.changePercent, volume: data.volume };
                    }
                }

                // Fallback: try watchlist endpoint price for same symbol
                const wlResp = await fetch(`${API_URL}/watchlist`, { credentials: 'include' });
                if (wlResp.ok) {
                    const wl = await wlResp.json();
                    const match = wl.find(s => s.symbol === symbol);
                    if (match && match.price > 0) return { price: match.price, change: match.change,
                                                            changePercent: match.changePercent, volume: match.volume };
                }

                return null;
            } catch (error) {
                console.error('Price fetch error:', error);
                return null;
            }
        }

        async function addToWatchlist() {
            const input = document.getElementById('watchlistSearch');
            const query = input.value.trim();
            
            if (!query) {
                alert('Please enter a company name');
                return;
            }
            
            document.getElementById('updateIndicator').style.display = 'flex';
            document.getElementById('updateIndicator').innerHTML = '<div class="loading"></div><span>Searching for stocks...</span>';
            
            const results = await searchIndiaStocks(query);
            
            document.getElementById('updateIndicator').style.display = 'none';
            
            if (results.length === 0) {
                alert('Stock not found. Try: Reliance, TCS, Infosys, HDFC Bank');
                return;
            }
            
            // If multiple results, show selection dialog
            let selectedStock;
            if (results.length > 1) {
                selectedStock = await showStockSelectionDialog(results, 'watchlist');
                if (!selectedStock) return; // User cancelled
            } else {
                selectedStock = results[0];
            }
            
            // Always fetch fresh watchlist from server before duplicate check
            // (local array can be stale after a remove)
            try {
                const freshResp = await fetch(API_URL + '/watchlist', { credentials: 'include' });
                if (freshResp.ok) {
                    const freshData = await freshResp.json();
                    if (Array.isArray(freshData)) watchlist = freshData;
                }
            } catch (e) { /* use existing watchlist if fetch fails */ }

            if (watchlist.find(s => s.symbol === selectedStock.symbol)) {
                alert('Stock already in watchlist');
                return;
            }
            
            document.getElementById('updateIndicator').style.display = 'flex';
            document.getElementById('updateIndicator').innerHTML = '<div class="loading"></div><span>Adding to watchlist...</span>';
            
            // Add to database
            try {
                const response = await fetch(API_URL + '/watchlist/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        symbol: selectedStock.symbol,
                        name: selectedStock.name
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Reload watchlist from database
                    await loadFromStorage();
                    renderWatchlist();
                    
                    // Refresh Deep Dive dropdown if initialized
                    if (typeof ddInitialized !== 'undefined' && ddInitialized) {
                        populateDDStockSelect();
                    }
                    
                    input.value = '';
                } else {
                    alert(result.message || 'Failed to add to watchlist');
                }
            } catch (error) {
                console.error('Error adding to watchlist:', error);
                alert('Error adding to watchlist');
            }
            
            document.getElementById('updateIndicator').style.display = 'none';
        }

        async function showStockSelectionDialog(results, type) {
            return new Promise((resolve) => {
                // Create modal overlay
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;
                
                // Create dialog
                const dialog = document.createElement('div');
                dialog.style.cssText = `
                    background: var(--bg-secondary);
                    border-radius: 12px;
                    padding: 2rem;
                    max-width: 600px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                    border: 1px solid var(--border-color);
                `;
                
                dialog.innerHTML = `
                    <h2 style="color: var(--text-primary); margin-bottom: 1rem; font-size: 1.5rem;">Select Stock</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Multiple stocks found. Please select the correct one:</p>
                    <div id="stockResults"></div>
                    <button id="cancelBtn" class="btn btn-danger" style="margin-top: 1.5rem; width: 100%;">Cancel</button>
                `;
                
                const resultsContainer = dialog.querySelector('#stockResults');
                
                results.forEach((stock, index) => {
                    const stockItem = document.createElement('div');
                    stockItem.style.cssText = `
                        background: var(--bg-tertiary);
                        border: 2px solid var(--border-color);
                        border-radius: 8px;
                        padding: 1.5rem;
                        margin-bottom: 1rem;
                        cursor: pointer;
                        transition: all 0.3s;
                    `;
                    
                    const exchange = stock.symbol.endsWith('.NS') ? 'NSE (National Stock Exchange)' : 
                                   stock.symbol.endsWith('.BO') ? 'BSE (Bombay Stock Exchange)' : 'Other';
                    
                    stockItem.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                            <div>
                                <div style="color: var(--text-primary); font-weight: 600; font-size: 1.1rem;">${stock.name}</div>
                                <div style="color: var(--accent-primary); font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; margin-top: 0.3rem;">${stock.symbol}</div>
                            </div>
                            <div style="background: var(--accent-primary); color: var(--bg-primary); padding: 0.3rem 0.8rem; border-radius: 6px; font-size: 0.85rem; font-weight: 600;">
                                ${exchange}
                            </div>
                        </div>
                    `;
                    
                    stockItem.addEventListener('mouseenter', () => {
                        stockItem.style.borderColor = 'var(--accent-primary)';
                        stockItem.style.transform = 'translateX(5px)';
                    });
                    
                    stockItem.addEventListener('mouseleave', () => {
                        stockItem.style.borderColor = 'var(--border-color)';
                        stockItem.style.transform = 'translateX(0)';
                    });
                    
                    stockItem.addEventListener('click', () => {
                        document.body.removeChild(overlay);
                        resolve(stock);
                    });
                    
                    resultsContainer.appendChild(stockItem);
                });
                
                dialog.querySelector('#cancelBtn').addEventListener('click', () => {
                    document.body.removeChild(overlay);
                    resolve(null);
                });
                
                overlay.appendChild(dialog);
                document.body.appendChild(overlay);
            });
        }

        async function removeFromWatchlist(symbol) {
            try {
                const response = await fetch(API_URL + '/watchlist/remove', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ symbol })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Reload watchlist from database
                    await loadFromStorage();
                    renderWatchlist();
                    
                    // Refresh Deep Dive dropdown if initialized
                    if (typeof ddInitialized !== 'undefined' && ddInitialized) {
                        populateDDStockSelect();
                    }
                }
            } catch (error) {
                console.error('Error removing from watchlist:', error);
            }
        }

        // â”€â”€ Watchlist row reorder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function moveWatchlistItem(index, direction) {
            const target = index + direction;
            if (target < 0 || target >= watchlist.length) return;
            [watchlist[index], watchlist[target]] = [watchlist[target], watchlist[index]];
            renderWatchlist();
            // Persist the new order to the database
            const symbols = watchlist.map(s => s.symbol);
            fetch(API_URL + '/watchlist/reorder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ symbols })
            }).catch(err => console.error('Reorder save failed:', err));
        }

        function renderWatchlist() {
            const tbody = document.getElementById('watchlistTable');
            
            if (watchlist.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <div class="empty-state-icon">ðŸ“ˆ</div>
                            <p>No stocks in watchlist. Add stocks to start tracking.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            const reorderBtnStyle = `
                display:block;width:26px;height:22px;line-height:1;font-size:0.7rem;
                background:var(--bg-tertiary);border:1px solid var(--border-color);
                border-radius:4px;color:var(--text-secondary);cursor:pointer;
                transition:border-color 0.15s,color 0.15s;
            `;
            const disabledExtra = `opacity:0.25;cursor:not-allowed;`;

            tbody.innerHTML = watchlist.map((stock, idx) => {
                const isFirst = idx === 0;
                const isLast  = idx === watchlist.length - 1;
                const changeClass = stock.change >= 0 ? 'change-positive' : 'change-negative';
                const changeSign = stock.change >= 0 ? '+' : '';
                const pctSign = stock.changePercent >= 0 ? '+' : '';
                const noPrice = !stock.price || stock.price === 0;
                const priceCell = noPrice
                    ? `<span class="price-skeleton"></span>`
                    : `â‚¹${stock.price.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                const changeCell = noPrice
                    ? `<span class="price-skeleton"></span>`
                    : `<div>${changeSign}${stock.change.toFixed(2)}</div><div style="font-size:0.8em;opacity:0.85;">(${pctSign}${stock.changePercent.toFixed(2)}%)</div>`;
                const volumeCell = noPrice
                    ? `<span class="price-skeleton"></span>`
                    : stock.volume.toLocaleString('en-IN');
                return `
                <tr data-symbol="${stock.symbol}" data-table="watchlist">
                    <td>
                        <div class="company-name">${stock.name}</div>
                    </td>
                    <td class="price">${priceCell}</td>
                    <td class="${noPrice ? '' : changeClass}">${changeCell}</td>
                    <td>${volumeCell}</td>
                    <td>
                        <button
                            onclick="removeFromWatchlist('${stock.symbol}')"
                            title="Remove"
                            style="background:none;border:1px solid rgba(239,68,68,0.4);border-radius:6px;color:#ef4444;cursor:pointer;padding:0.35rem 0.5rem;font-size:1.1rem;line-height:1;transition:background 0.2s,border-color 0.2s;"
                            onmouseenter="this.style.background='rgba(239,68,68,0.15)';this.style.borderColor='#ef4444';"
                            onmouseleave="this.style.background='none';this.style.borderColor='rgba(239,68,68,0.4)';">ðŸ—‘ï¸</button>
                    </td>
                    <td style="text-align:center;padding:0.8rem 0.5rem;">
                        <div style="display:inline-flex;flex-direction:column;gap:2px;align-items:center;">
                            <button
                                onclick="moveWatchlistItem(${idx},-1)"
                                title="Move up"
                                style="${reorderBtnStyle}${isFirst ? disabledExtra : ''}"
                                ${isFirst ? 'disabled' : ''}
                                onmouseenter="if(!this.disabled)this.style.borderColor='var(--accent-primary)',this.style.color='var(--accent-primary)'"
                                onmouseleave="this.style.borderColor='var(--border-color)',this.style.color='var(--text-secondary)'">â–²</button>
                            <button
                                onclick="moveWatchlistItem(${idx},1)"
                                title="Move down"
                                style="${reorderBtnStyle}${isLast ? disabledExtra : ''}"
                                ${isLast ? 'disabled' : ''}
                                onmouseenter="if(!this.disabled)this.style.borderColor='var(--accent-primary)',this.style.color='var(--accent-primary)'"
                                onmouseleave="this.style.borderColor='var(--border-color)',this.style.color='var(--text-secondary)'">â–¼</button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        async function addToPortfolio() {
            const input = document.getElementById('portfolioSearch');
            const quantityInput = document.getElementById('quantityInput');
            const query = input.value.trim();
            const quantity = parseInt(quantityInput.value);
            
            if (!query) {
                alert('Please enter a company name');
                return;
            }
            
            if (!quantity || quantity < 1) {
                alert('Please enter a valid quantity');
                return;
            }
            
            document.getElementById('updateIndicator').style.display = 'flex';
            document.getElementById('updateIndicator').innerHTML = '<div class="loading"></div><span>Searching for stocks...</span>';
            
            const results = await searchIndiaStocks(query);
            document.getElementById('updateIndicator').style.display = 'none';
            
            if (results.length === 0) {
                alert('Stock not found. Try: Reliance, TCS, Infosys, HDFC Bank');
                return;
            }
            
            // If multiple results, show selection dialog
            let selectedStock;
            if (results.length > 1) {
                selectedStock = await showStockSelectionDialog(results, 'portfolio');
                if (!selectedStock) return; // User cancelled
            } else {
                selectedStock = results[0];
            }
            
            document.getElementById('updateIndicator').style.display = 'flex';
            document.getElementById('updateIndicator').innerHTML = '<div class="loading"></div><span>Fetching price...</span>';
            
            const priceData = await fetchStockPrice(selectedStock.symbol);
            const buyPrice = priceData ? priceData.price : 0;
            
            // Don't block the add if price fetch fails â€” price will update on next refresh
            if (!buyPrice) {
                console.warn('Price fetch failed for', selectedStock.symbol, 'â€” adding with price 0, will update on refresh');
            }
            
            // Add to database
            try {
                const response = await fetch(API_URL + '/portfolio/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        symbol: selectedStock.symbol,
                        name: selectedStock.name,
                        quantity: quantity,
                        buy_price: buyPrice,
                        buy_date: new Date().toISOString().split('T')[0]
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Reload from database
                    await loadFromStorage();
                    renderPortfolio();
                    updatePortfolioChart();
                    input.value = '';
                    quantityInput.value = '1';
                } else {
                    alert(result.message || 'Failed to add to portfolio');
                }
            } catch (error) {
                console.error('Error adding to portfolio:', error);
                alert('Error adding to portfolio');
            }
            
            document.getElementById('updateIndicator').style.display = 'none';
        }

        async function removeFromPortfolio(holdingId) {
            try {
                const response = await fetch(API_URL + '/portfolio/remove', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ holding_id: holdingId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    await loadFromStorage();
                    renderPortfolio();
                    updatePortfolioChart();
                }
            } catch (error) {
                console.error('Error removing from portfolio:', error);
            }
        }

        function updateQuantity(symbol, newQuantity) {
            const stock = portfolio.find(s => s.symbol === symbol);
            if (stock) {
                stock.quantity = parseInt(newQuantity) || 1;
                stock.totalValue = stock.price * stock.quantity;
                saveToStorage();
                renderPortfolio();
                updatePortfolioChart();
            }
        }

        function renderPortfolio() {
            const tbody = document.getElementById('portfolioTable');
            
            if (portfolio.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <div class="empty-state-icon">ðŸ’¼</div>
                            <p>No stocks in portfolio. Add stocks to start building your portfolio.</p>
                        </td>
                    </tr>
                `;
                updatePortfolioStats();
                return;
            }

            // Use priceCache for current price where available, fallback to stored price
            const getPrice = (stock) => {
                const cached = priceCache[stock.symbol];
                return cached ? cached.price : (stock.current_price || stock.price || 0);
            };

            const totalPortfolioValue = portfolio.reduce((sum, stock) => {
                return sum + getPrice(stock) * (stock.quantity || 0);
            }, 0);

            // Sort by current value descending
            const sortedPortfolio = [...portfolio].sort((a, b) => {
                return (getPrice(b) * (b.quantity || 0)) - (getPrice(a) * (a.quantity || 0));
            });
            
            tbody.innerHTML = sortedPortfolio.map(stock => {
                const currentPrice = getPrice(stock);
                const currentValue = currentPrice * (stock.quantity || 0);
                const portfolioPct = totalPortfolioValue > 0 ? (currentValue / totalPortfolioValue * 100) : 0;
                return `
                    <tr data-symbol="${stock.symbol}" data-table="portfolio">
                        <td>
                            <div class="company-name">${stock.name}</div>
                        </td>
                        <td class="price">â‚¹${currentPrice.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>${stock.quantity || 0}</td>
                        <td class="price">â‚¹${currentValue.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>${portfolioPct.toFixed(2)}%</td>
                        <td>
                            <button
                            onclick="removeFromPortfolio(${stock.id})"
                            title="Remove"
                            style="background:none;border:1px solid rgba(239,68,68,0.4);border-radius:6px;color:#ef4444;cursor:pointer;padding:0.35rem 0.5rem;font-size:1.1rem;line-height:1;transition:background 0.2s,border-color 0.2s;"
                            onmouseenter="this.style.background='rgba(239,68,68,0.15)';this.style.borderColor='#ef4444';"
                            onmouseleave="this.style.background='none';this.style.borderColor='rgba(239,68,68,0.4)';">ðŸ—‘ï¸</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            updatePortfolioStats();
        }

        function updatePortfolioStats() {
            const totalInvested = portfolio.reduce((sum, stock) => sum + ((stock.buy_price || 0) * (stock.quantity || 0)), 0);
            const totalCurrent = portfolio.reduce((sum, stock) => sum + ((stock.current_price || stock.price || 0) * (stock.quantity || 0)), 0);
            const totalProfitLoss = totalCurrent - totalInvested;
            const totalProfitLossPercent = totalInvested > 0 ? (totalProfitLoss / totalInvested * 100) : 0;
            const totalStocks = portfolio.length;
            
            document.getElementById('totalValue').textContent = `â‚¹${totalCurrent.toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
            document.getElementById('totalStocks').textContent = totalStocks;
            
            // Update profit/loss if elements exist
            const plElement = document.getElementById('totalProfitLoss');
            if (plElement) {
                plElement.textContent = `â‚¹${totalProfitLoss.toLocaleString('en-IN', {minimumFractionDigits: 2})} (${totalProfitLossPercent >= 0 ? '+' : ''}${totalProfitLossPercent.toFixed(2)}%)`;
                plElement.className = totalProfitLoss >= 0 ? 'positive' : 'negative';
            }
        }

        function updatePortfolioChart() {
            const canvas = document.getElementById('portfolioChart');
            const ctx = canvas.getContext('2d');
            
            if (portfolio.length === 0) {
                if (chartInstance) {
                    chartInstance.destroy();
                    chartInstance = null;
                }
                return;
            }
            
            const data = portfolio.map(stock => (stock.current_price || stock.price || 0) * (stock.quantity || 0));
            // Remove .NS and .BO from labels
            const labels = portfolio.map(stock => stock.symbol.replace('.NS', '').replace('.BO', ''));
            const colors = [
                '#00d4ff', '#7c3aed', '#10b981', '#f59e0b', 
                '#ef4444', '#ec4899', '#8b5cf6', '#06b6d4',
                '#14b8a6', '#f97316', '#84cc16', '#6366f1'
            ];
            
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            // Plugin to draw only percentages inside
            const percentagePlugin = {
                id: 'percentageLabels',
                afterDatasetDraw(chart) {
                    const ctx = chart.ctx;
                    const meta = chart.getDatasetMeta(0);
                    const total = chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                    
                    meta.data.forEach((arc, index) => {
                        const percentage = ((chart.data.datasets[0].data[index] / total) * 100).toFixed(1);
                        
                        // Get center point of the arc
                        const centerAngle = (arc.startAngle + arc.endAngle) / 2;
                        
                        // Calculate the radius for label placement
                        const innerRadius = (arc.innerRadius + arc.outerRadius) / 2;
                        const x = arc.x + Math.cos(centerAngle) * innerRadius;
                        const y = arc.y + Math.sin(centerAngle) * innerRadius;
                        
                        // Show percentage for all slices, adjust font size for very small ones
                        let fontSize = 16;
                        if (parseFloat(percentage) < 5) {
                            fontSize = 13;  // Smaller font for tiny slices
                        }
                        
                        ctx.save();
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillStyle = '#ffffff';
                        ctx.font = `bold ${fontSize}px Poppins`;
                        ctx.shadowColor = 'rgba(0, 0, 0, 0.9)';
                        ctx.shadowBlur = 8;
                        ctx.fillText(`${percentage}%`, x, y);
                        ctx.restore();
                    });
                }
            };
            
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderColor: '#1e2442',
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    layout: {
                        padding: 20
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#1e2442',
                            titleColor: '#ffffff',
                            bodyColor: '#a0aec0',
                            borderColor: '#2d3748',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: â‚¹${value.toLocaleString('en-IN', {minimumFractionDigits: 2})} (${percentage}%)`;
                                }
                            }
                        }
                    }
                },
                plugins: [percentagePlugin]
            });
        }

        // â”€â”€ Fast AJAX Price Polling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let priceCache = {};       // symbol -> last known price data
        let pollingActive = false;

        async function pollPrices() {
            if (pollingActive) return;
            const allSymbols = [
                ...watchlist.map(s => s.symbol),
                ...portfolio.map(s => s.symbol)
            ];
            const symbols = [...new Set(allSymbols)].filter(Boolean);
            if (symbols.length === 0) return;

            pollingActive = true;
            const { host: proxyHost, port: proxyPort } = parseProxy();

            try {
                const resp = await fetch(`${API_URL}/prices/bulk`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ symbols, proxy_host: proxyHost, proxy_port: proxyPort })
                });

                if (!resp.ok) return;
                const data = await resp.json();
                const prices = data.prices || {};

                let anyChange = false;

                // Update only cells that changed â€” no full re-render
                for (const [symbol, pdata] of Object.entries(prices)) {
                    const prev = priceCache[symbol];
                    const changed = !prev ||
                        prev.price !== pdata.price ||
                        prev.changePercent !== pdata.changePercent;

                    if (changed) {
                        anyChange = true;
                        priceCache[symbol] = pdata;
                        updatePriceCells(symbol, pdata);
                    }
                }

                if (anyChange) updatePortfolioChart();

            } catch (e) {
                console.error('Price poll error:', e);
            } finally {
                pollingActive = false;
            }
        }

        function updatePriceCells(symbol, pdata) {
            const { price, change, changePercent, volume } = pdata;
            const isUp = change >= 0;
            const sign = isUp ? '+' : '';
            const priceStr = `â‚¹${price.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            const changeStr = `${sign}${change.toFixed(2)}`;
            const pctStr = `${sign}${changePercent.toFixed(2)}%`;
            const volStr = volume ? volume.toLocaleString('en-IN') : '-';
            const badgeClass = isUp ? 'badge-success' : 'badge-danger';
            const arrow = isUp ? 'â–²' : 'â–¼';

            // Update watchlist row
            // Column order: Company(0), Price(1), Change(2), Volume(3), Action(4), Order(5)
            const wlRow = document.querySelector(`[data-symbol="${symbol}"][data-table="watchlist"]`);
            if (wlRow) {
                const cells = wlRow.querySelectorAll('td');
                if (cells.length >= 4) {
                    cells[1].innerHTML = `<span class="price">${priceStr}</span>`;
                    cells[2].innerHTML = `<div class="${isUp ? 'change-positive' : 'change-negative'}"><div>${changeStr}</div><div style="font-size:0.8em;opacity:0.85;">(${sign}${changePercent.toFixed(2)}%)</div></div>`;
                    cells[3].textContent = volStr;
                    // Flash animation
                    wlRow.classList.remove('price-flash-up', 'price-flash-down');
                    void wlRow.offsetWidth;
                    wlRow.classList.add(isUp ? 'price-flash-up' : 'price-flash-down');
                }
            }

            // Update portfolio row
            const pfRow = document.querySelector(`[data-symbol="${symbol}"][data-table="portfolio"]`);
            if (pfRow) {
                const cells = pfRow.querySelectorAll('td');
                const stock = portfolio.find(s => s.symbol === symbol);
                if (cells.length >= 5 && stock) {
                    const qty = stock.quantity || 0;
                    const totalVal = (price * qty).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    cells[1].innerHTML = `<span class="price">${priceStr}</span>`;
                    cells[3].innerHTML = `<span class="price">â‚¹${totalVal}</span>`;
                    pfRow.classList.remove('price-flash-up', 'price-flash-down');
                    void pfRow.offsetWidth;
                    pfRow.classList.add(isUp ? 'price-flash-up' : 'price-flash-down');
                }
                updatePortfolioStats();
            }

            // Recalculate % column for ALL portfolio rows (total changes when any price changes)
            const totalPort = portfolio.reduce((sum, s) => {
                const cp = priceCache[s.symbol];
                return sum + (cp ? cp.price * (s.quantity || 0) : (s.current_price || s.price || 0) * (s.quantity || 0));
            }, 0);
            document.querySelectorAll('[data-table="portfolio"]').forEach(row => {
                const rowSymbol = row.getAttribute('data-symbol');
                const rowStock = portfolio.find(s => s.symbol === rowSymbol);
                if (!rowStock) return;
                const rowPrice = priceCache[rowSymbol] ? priceCache[rowSymbol].price : (rowStock.current_price || rowStock.price || 0);
                const rowVal = rowPrice * (rowStock.quantity || 0);
                const rowPct = totalPort > 0 ? (rowVal / totalPort * 100).toFixed(2) : '0.00';
                const rowCells = row.querySelectorAll('td');
                if (rowCells[4]) rowCells[4].textContent = `${rowPct}%`;
            });
        }

        function updatePortfolioStats() {
            let totalVal = 0;
            portfolio.forEach(s => {
                const cp = priceCache[s.symbol];
                if (cp) totalVal += cp.price * (s.quantity || 0);
            });
            const totalEl = document.getElementById('totalValue');
            const countEl = document.getElementById('totalStocks');
            if (totalEl) totalEl.textContent = `â‚¹${totalVal.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            if (countEl) countEl.textContent = portfolio.length;
        }

        async function updatePrices() {
            if (watchlist.length === 0 && portfolio.length === 0) return;
            console.log('ðŸ”„ Full refresh...');
            try {
                await loadFromStorage();
                renderWatchlist();
                renderPortfolio();
                updatePortfolioChart();
                // Seed the cache after full render
                await pollPrices();
            } catch (error) {
                console.error('Update error:', error);
            }
        }

        let announcementInterval = null;
        let knownAnnouncementIds = new Set();
        let announcementsInitialized = false;

        function startAutoUpdate() {
            // Fast price polling every 5 seconds (AJAX-style, in-place updates)
            setInterval(pollPrices, 5000);

            // Full data refresh every 5 minutes (re-sync with DB)
            updateInterval = setInterval(() => {
                loadFromStorage().then(() => {
                    renderWatchlist();
                    renderPortfolio();
                });
            }, 5 * 60 * 1000);

            // Announcements every 5 minutes
            announcementInterval = setInterval(() => {
                checkNewAnnouncements();
            }, 5 * 60 * 1000);
        }

        // Called on tab switch - renders without alerting
        async function updateAnnouncements() {
            await fetchAndRenderAnnouncements(false);
        }

        // Called by timer - silently checks for new ones and alerts
        async function checkNewAnnouncements() {
            await fetchAndRenderAnnouncements(true);
        }

        async function fetchAndRenderAnnouncements(alertOnNew) {
            const container = document.getElementById('announcementsList');

            if (watchlist.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“¢</div>
                        <p>No announcements available. Add stocks to your watchlist to see relevant announcements.</p>
                    </div>
                `;
                return;
            }

            // Only show loading spinner on first load
            if (!announcementsInitialized) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="loading"></div>
                        <p style="margin-top:1rem;">Fetching corporate announcements from NSE...</p>
                    </div>
                `;
            }

            try {
                const symbols = watchlist.map(s => s.symbol);
                const { host: proxyHost, port: proxyPort } = parseProxy();

                const response = await fetch(`${API_URL}/announcements`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbols, proxy_host: proxyHost, proxy_port: proxyPort })
                });

                if (!response.ok) throw new Error('Failed to fetch announcements');

                let announcements = (await response.json()).announcements || [];

                // Sort newest first on frontend too
                const DATE_MONTHS = {
                    'jan':1,'feb':2,'mar':3,'apr':4,'may':5,'jun':6,
                    'jul':7,'aug':8,'sep':9,'oct':10,'nov':11,'dec':12
                };
                function parseAnnDate(s) {
                    if (!s) return 0;
                    s = s.trim();
                    const m = s.match(/(\d{1,2})-([A-Za-z]{3})-(\d{4})(?:\s+(\d{2}):(\d{2})(?::(\d{2}))?)?/);
                    if (m) {
                        const mon = DATE_MONTHS[m[2].toLowerCase()];
                        if (mon) return new Date(
                            parseInt(m[3]), mon-1, parseInt(m[1]),
                            parseInt(m[4]||0), parseInt(m[5]||0), parseInt(m[6]||0)
                        ).getTime();
                    }
                    const d = new Date(s);
                    return isNaN(d.getTime()) ? 0 : d.getTime();
                }
                announcements.sort((a, b) => parseAnnDate(b.date) - parseAnnDate(a.date));

                // â”€â”€ detect new announcements â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                const newOnes = [];
                announcements.forEach(ann => {
                    // unique ID = symbol + date + title
                    const id = `${ann.symbol}|${ann.date}|${ann.title}`;
                    if (!knownAnnouncementIds.has(id)) {
                        knownAnnouncementIds.add(id);
                        if (announcementsInitialized) newOnes.push(ann); // only alert after first load
                    }
                });

                announcementsInitialized = true;

                // â”€â”€ alert for new announcements â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                if (alertOnNew && newOnes.length > 0) {
                    showNewAnnouncementAlert(newOnes);
                }

                // â”€â”€ render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                if (announcements.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ðŸ“¢</div>
                            <p>No recent corporate announcements available.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = announcements.map(ann => {
                    const ms = parseAnnDate(ann.date);
                    let dateStr = ann.date || '';
                    if (ms > 0) {
                        const d = new Date(ms);
                        dateStr = d.toLocaleDateString('en-IN', { year:'numeric', month:'short', day:'numeric' });
                        const timePart = ann.date.match(/(\d{2}:\d{2})/);
                        if (timePart) dateStr += ' ' + timePart[1];
                    }
                    const id = `${ann.symbol}|${ann.date}|${ann.title}`;
                    const isNew = newOnes.some(n => `${n.symbol}|${n.date}|${n.title}` === id);

                    return `
                        <div class="announcement-item" ${isNew ? 'style="border-color: var(--accent-primary); background: rgba(0,212,255,0.05);"' : ''}>
                            <div class="announcement-header">
                                <div style="display:flex; align-items:center; gap:0.6rem;">
                                    ${isNew ? '<span style="background:var(--accent-primary);color:#000;font-size:0.7rem;font-weight:700;padding:0.2rem 0.5rem;border-radius:4px;">NEW</span>' : ''}
                                    <div>
                                        <div class="announcement-company">${ann.company}</div>
                                        <div class="stock-symbol">${ann.symbol.replace('.NS','').replace('.BO','')} â€¢ ${ann.exchange}</div>
                                    </div>
                                </div>
                                <div class="announcement-date">${dateStr}</div>
                            </div>
                            <div class="announcement-title">${ann.title}</div>
                            ${ann.category ? `<div style="margin-top:0.5rem;">
                                <span style="background:var(--bg-tertiary);color:var(--text-secondary);padding:0.2rem 0.6rem;border-radius:4px;font-size:0.8rem;">${ann.category}</span>
                            </div>` : ''}
                            ${ann.attachment_url ? `<div style="margin-top:0.5rem;">
                                <a href="${ann.attachment_url}" target="_blank" rel="noopener noreferrer"
                                   style="color:var(--accent-primary);font-size:0.85rem;text-decoration:none;">
                                   ðŸ“Ž View Document
                                </a>
                            </div>` : ''}
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Announcements error:', error);
                if (!announcementsInitialized) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">âš ï¸</div>
                            <p>Unable to fetch announcements. Make sure the backend is running.</p>
                        </div>
                    `;
                }
            }
        }

        function showNewAnnouncementAlert(newOnes) {
            // Remove existing alert if any
            const existing = document.getElementById('announcementAlert');
            if (existing) existing.remove();

            const alert = document.createElement('div');
            alert.id = 'announcementAlert';
            alert.style.cssText = `
                position: fixed;
                top: 1.5rem;
                right: 1.5rem;
                background: var(--bg-secondary);
                border: 2px solid var(--accent-primary);
                border-radius: 12px;
                padding: 1.2rem 1.5rem;
                z-index: 99999;
                max-width: 380px;
                box-shadow: 0 8px 32px rgba(0,212,255,0.25);
                animation: slideIn 0.4s ease;
            `;

            const list = newOnes.slice(0, 3).map(a =>
                `<div style="margin-top:0.5rem;padding-top:0.5rem;border-top:1px solid var(--border-color);">
                    <div style="font-weight:600;color:var(--text-primary);font-size:0.9rem;">${a.company}</div>
                    <div style="color:var(--text-secondary);font-size:0.82rem;margin-top:0.2rem;">${a.title}</div>
                </div>`
            ).join('');

            const more = newOnes.length > 3
                ? `<div style="color:var(--accent-primary);font-size:0.82rem;margin-top:0.5rem;">+${newOnes.length - 3} more</div>` : '';

            alert.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.3rem;">
                    <div style="color:var(--accent-primary);font-weight:700;font-size:1rem;">
                        ðŸ”” ${newOnes.length} New Announcement${newOnes.length > 1 ? 's' : ''}
                    </div>
                    <button onclick="document.getElementById('announcementAlert').remove()"
                        style="background:none;border:none;color:var(--text-secondary);cursor:pointer;font-size:1.2rem;line-height:1;">âœ•</button>
                </div>
                ${list}${more}
                <button onclick="if(window.innerWidth<=768){switchTabMobile(2);}else{switchTab(2);}document.getElementById('announcementAlert').remove();"
                    style="margin-top:1rem;width:100%;padding:0.6rem;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));
                    border:none;border-radius:8px;color:#fff;font-weight:600;cursor:pointer;font-size:0.9rem;">
                    View Announcements
                </button>
            `;

            document.body.appendChild(alert);

            // Auto-dismiss after 30 seconds
            setTimeout(() => { if (alert.parentNode) alert.remove(); }, 30000);
        }
        window.addEventListener('load', init);

        // Proxy inputs are optional â€” only wire up if they exist in the DOM
        const _phi = document.getElementById('proxyHostInput');
        const _ppi = document.getElementById('proxyPortInput');
        if (_phi) _phi.addEventListener('change', saveProxySettings);
        if (_ppi) _ppi.addEventListener('change', saveProxySettings);
    </script>
    <!-- Fullscreen answer modal -->
    <div id="ddFullscreenModal">
        <div class="dd-fs-header">
            <div class="dd-fs-title">ðŸ”¬ <span id="ddFsTitle">Deep Dive AI Analyst</span></div>
            <div class="dd-fs-actions">
                <button class="dd-fs-btn" onclick="closeFullscreen()">â¤¡ Back to app</button>
                <button class="dd-fs-close" onclick="closeFullscreen()">âœ•</button>
            </div>
        </div>
        <div id="ddFsMessages"></div>
        <div class="dd-fs-input-wrap">
            <div class="dd-fs-input-inner">
                <textarea id="ddFsQuestion" placeholder="Ask anything about this company..."
                    onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();askDeepDiveFs();}"></textarea>
                <button onclick="askDeepDiveFs()">âž¤</button>
            </div>
        </div>
    </div>

    <script>
    // â”€â”€ Fullscreen answer panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let _fsOpen = false;

    function detachAnswerPanel() {
        const modal   = document.getElementById('ddFullscreenModal');
        const srcMsgs = document.getElementById('ddMessages');
        const dstMsgs = document.getElementById('ddFsMessages');
        const title   = document.getElementById('ddChatTitle').textContent;

        dstMsgs.innerHTML = srcMsgs.innerHTML;
        document.getElementById('ddFsTitle').textContent = title;

        modal.classList.add('active');
        _fsOpen = true;
        document.body.style.overflow = 'hidden';
        setTimeout(() => { dstMsgs.scrollTop = dstMsgs.scrollHeight; }, 50);
    }

    function closeFullscreen() {
        const modal   = document.getElementById('ddFullscreenModal');
        const srcMsgs = document.getElementById('ddFsMessages');
        const dstMsgs = document.getElementById('ddMessages');

        dstMsgs.innerHTML = srcMsgs.innerHTML;
        modal.classList.remove('active');
        _fsOpen = false;
        document.body.style.overflow = '';
        dstMsgs.scrollTop = dstMsgs.scrollHeight;
    }

    function syncToFullscreen() {
        if (!_fsOpen) return;
        const src = document.getElementById('ddMessages');
        const dst = document.getElementById('ddFsMessages');
        dst.innerHTML = src.innerHTML;
        dst.scrollTop = dst.scrollHeight;
    }

    async function askDeepDiveFs() {
        const q = document.getElementById('ddFsQuestion').value.trim();
        if (!q) return;
        document.getElementById('ddQuestion').value = q;
        document.getElementById('ddFsQuestion').value = '';
        await askDeepDive();
        setTimeout(syncToFullscreen, 300);
        setTimeout(syncToFullscreen, 2000);
        setTimeout(syncToFullscreen, 6000);
    }

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && _fsOpen) closeFullscreen();
    });
    </script>
</body>
</html>
