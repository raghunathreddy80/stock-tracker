<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Portfolio Tracker</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #151932;
            --bg-tertiary: #1e2442;
            --accent-primary: #00d4ff;
            --accent-secondary: #7c3aed;
            --text-primary: #ffffff;
            --text-secondary: #a0aec0;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --border-color: #2d3748;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #1a1f3a 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(ellipse at 20% 30%, rgba(0, 212, 255, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 70%, rgba(124, 58, 237, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 2px solid var(--border-color);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.5rem;
            box-shadow: 0 8px 16px rgba(0, 212, 255, 0.3);
        }
        
        .logo-text h1 {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .logo-text p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 300;
        }
        
        .proxy-settings {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: var(--bg-secondary);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        
        .proxy-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: var(--bg-tertiary);
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s;
            border: 1px solid var(--border-color);
        }
        
        .toggle-switch.active {
            background: var(--accent-primary);
        }
        
        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        
        .toggle-switch.active .toggle-slider {
            transform: translateX(24px);
        }
        
        .proxy-input {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            width: 250px;
        }
        
        .proxy-input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: var(--bg-secondary);
            padding: 0.5rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        
        .tab {
            flex: 1;
            padding: 1rem 2rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .tab:hover {
            color: var(--text-primary);
            background: rgba(0, 212, 255, 0.1);
        }
        
        .tab.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: var(--text-primary);
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .search-section {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }
        
        .search-bar {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .search-input {
            flex: 1;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            padding: 1rem 1.5rem;
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }
        
        .quantity-input {
            width: 120px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            padding: 1rem;
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
        }
        
        .btn {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            border-radius: 10px;
            color: var(--text-primary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 212, 255, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        .btn-danger:hover {
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
        }
        
        .table-container {
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: var(--bg-tertiary);
        }
        
        th {
            padding: 1.5rem 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }
        
        tbody tr {
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s;
        }
        
        tbody tr:hover {
            background: rgba(0, 212, 255, 0.05);
        }
        
        td {
            padding: 1.5rem 1rem;
            font-size: 0.95rem;
        }
        
        .company-name {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .stock-symbol {
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .price {
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
        }
        
        .change-positive {
            color: var(--success);
            font-weight: 600;
        }
        
        .change-negative {
            color: var(--danger);
            font-weight: 600;
        }
        
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.3rem 0.8rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .badge-success {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }
        
        .badge-danger {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }
        
        .portfolio-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--accent-primary), var(--accent-secondary));
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
        }
        
        .chart-container {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 600px;
        }
        
        #portfolioChart {
            max-width: 700px;
            max-height: 700px;
        }
        
        .announcement-item {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin-bottom: 1rem;
            transition: all 0.3s;
        }
        
        .announcement-item:hover {
            border-color: var(--accent-primary);
            transform: translateX(5px);
        }
        
        .announcement-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }
        
        .announcement-company {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.1rem;
        }
        
        .announcement-date {
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .announcement-title {
            color: var(--text-secondary);
            font-size: 0.95rem;
            line-height: 1.6;
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 212, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-primary);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from { transform: translateX(120%); opacity: 0; }
            to   { transform: translateX(0);    opacity: 1; }
        }

        /* ‚îÄ‚îÄ Deep Dive ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .deepdive-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 1.5rem;
            height: calc(100vh - 260px);
            min-height: 600px;
        }
        .deepdive-sidebar {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
        }
        .deepdive-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.2rem;
        }
        .deepdive-label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 0.7rem;
        }
        .deepdive-select {
            width: 100%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            padding: 0.7rem 1rem;
            font-size: 0.95rem;
            font-family: inherit;
            cursor: pointer;
            outline: none;
        }
        .deepdive-select:focus { border-color: var(--accent-primary); }

        .deepdive-sources { display: flex; flex-direction: column; gap: 0.5rem; }
        .dd-source-item {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.6rem 0.8rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.82rem;
            transition: border-color 0.2s;
        }
        .dd-source-item.loaded { border-color: #10b981; }
        .dd-source-item.error  { border-color: #ef4444; opacity: 0.6; }
        .dd-source-item .dd-source-icon { font-size: 1rem; flex-shrink: 0; }
        .dd-source-item .dd-source-name { color: var(--text-primary); flex: 1; line-height: 1.3; }
        .dd-source-item .dd-source-badge {
            font-size: 0.7rem;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-weight: 600;
            flex-shrink: 0;
        }
        .dd-source-item.loaded .dd-source-badge { background: #10b98122; color: #10b981; }
        .dd-source-item.error  .dd-source-badge { background: #ef444422; color: #ef4444; }
        .dd-source-item.loading .dd-source-badge { background: var(--bg-secondary); color: var(--text-secondary); }

        .dd-context-stats {
            font-size: 0.82rem;
            color: var(--text-secondary);
            line-height: 1.8;
        }
        .dd-context-stats span { color: var(--accent-primary); font-weight: 600; }

        /* Chat area */
        .deepdive-chat {
            display: flex;
            flex-direction: column;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }
        .deepdive-chat-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .deepdive-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .dd-welcome {
            margin: auto;
            text-align: center;
            max-width: 500px;
            padding: 2rem;
        }
        .dd-suggestions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 1.2rem;
            text-align: left;
        }
        .dd-suggestion {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.6rem 0.8rem;
            font-size: 0.82rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            line-height: 1.4;
        }
        .dd-suggestion:hover {
            border-color: var(--accent-primary);
            color: var(--text-primary);
            background: rgba(0,212,255,0.05);
        }
        .dd-message {
            display: flex;
            gap: 0.8rem;
            animation: fadeIn 0.3s ease;
        }
        .dd-message.user { flex-direction: row-reverse; }
        .dd-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        .dd-message.user .dd-avatar { background: var(--accent-primary); color: #000; }
        .dd-message.ai .dd-avatar   { background: var(--bg-tertiary); border: 1px solid var(--border-color); }
        .dd-bubble {
            max-width: 75%;
            padding: 0.9rem 1.1rem;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        .dd-message.user .dd-bubble {
            background: var(--accent-primary);
            color: #000;
            border-bottom-right-radius: 4px;
        }
        .dd-message.ai .dd-bubble {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
            border: 1px solid var(--border-color);
        }
        .dd-bubble p { margin: 0 0 0.5rem; }
        .dd-bubble p:last-child { margin: 0; }
        .dd-bubble strong { color: var(--accent-primary); }
        .dd-bubble ul { margin: 0.3rem 0; padding-left: 1.2rem; }
        .dd-bubble li { margin: 0.2rem 0; }
        .dd-typing {
            display: flex;
            gap: 4px;
            align-items: center;
            padding: 0.5rem 0;
        }
        .dd-typing span {
            width: 7px; height: 7px;
            background: var(--accent-primary);
            border-radius: 50%;
            animation: ddBounce 1.2s infinite;
        }
        .dd-typing span:nth-child(2) { animation-delay: 0.2s; }
        .dd-typing span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes ddBounce {
            0%,60%,100% { transform: translateY(0); }
            30% { transform: translateY(-6px); }
        }
        .deepdive-input-area {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 0.8rem;
            align-items: flex-end;
            background: var(--bg-tertiary);
        }
        .deepdive-textarea {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            padding: 0.8rem 1rem;
            font-size: 0.95rem;
            font-family: inherit;
            resize: none;
            min-height: 44px;
            max-height: 120px;
            outline: none;
            line-height: 1.5;
        }
        .deepdive-textarea:focus { border-color: var(--accent-primary); }
        .dd-send-btn {
            width: 44px; height: 44px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            border-radius: 10px;
            color: #000;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .dd-send-btn:hover { transform: scale(1.05); }
        .dd-send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .dd-loading { color: var(--text-secondary); font-size: 0.85rem; padding: 0.5rem 0; }

        .dd-view-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 0.15rem 0.35rem;
            font-size: 0.85rem;
            cursor: pointer;
            text-decoration: none;
            transition: border-color 0.2s;
            display: inline-flex;
            align-items: center;
        }
        .dd-view-btn:hover { border-color: var(--accent-primary); }

        .dd-expand-btn {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 0.1rem 0.35rem;
            font-size: 0.75rem;
            cursor: pointer;
            color: var(--accent-primary);
            transition: border-color 0.2s;
        }
        .dd-expand-btn:hover { border-color: var(--accent-primary); }

        .dd-subdocs {
            margin-top: 0.4rem;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        .dd-subdoc-link {
            display: flex;
            flex-direction: column;
            padding: 0.3rem 0.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.75rem;
            color: var(--text-primary);
            transition: border-color 0.2s;
            line-height: 1.4;
        }
        .dd-subdoc-link:hover { border-color: var(--accent-primary); color: var(--accent-primary); }
        
        .update-indicator {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--bg-secondary);
            padding: 1rem 1.5rem;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 0.8rem;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            z-index: 1000;
        }
        
        .editable-quantity {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            padding: 0.5rem 0.8rem;
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            width: 80px;
            text-align: center;
        }
        
        .editable-quantity:focus {
            outline: none;
            border-color: var(--accent-primary);
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header {
                flex-direction: column;
                gap: 1rem;
            }
            
            .proxy-settings {
                flex-direction: column;
            }
            
            .search-bar {
                flex-direction: column;
            }
            
            .quantity-input {
                width: 100%;
            }
            
            table {
                font-size: 0.85rem;
            }
            
            th, td {
                padding: 1rem 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <div class="logo-icon">‚Çπ</div>
                <div class="logo-text">
                    <h1>Stock Tracker Pro</h1>
                    <p>Real-time Portfolio Management</p>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab(0)">üìä Watchlist</button>
            <button class="tab" onclick="switchTab(1)">üíº Portfolio</button>
            <button class="tab" onclick="switchTab(2)">üì¢ Announcements</button>
            <button class="tab" onclick="switchTab(3)">üî¨ Deep Dive</button>
        </div>

        <div class="tab-content active" id="watchlist">
            <div class="search-section">
                <div class="search-bar">
                    <input type="text" class="search-input" id="watchlistSearch" placeholder="Enter company name (e.g., Reliance, TCS, Infosys)">
                    <button class="btn" onclick="addToWatchlist()">Add to Watchlist</button>
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Company</th>
                            <th>Price (‚Çπ)</th>
                            <th>Change (‚Çπ)</th>
                            <th>Change (%)</th>
                            <th>Volume</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="watchlistTable">
                        <tr>
                            <td colspan="6" class="empty-state">
                                <div class="empty-state-icon">üìà</div>
                                <p>No stocks in watchlist. Add stocks to start tracking.</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-content" id="portfolio">
            <div class="portfolio-stats">
                <div class="stat-card">
                    <div class="stat-label">Total Portfolio Value</div>
                    <div class="stat-value" id="totalValue">‚Çπ0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Stocks</div>
                    <div class="stat-value" id="totalStocks">0</div>
                </div>
            </div>

            <div class="search-section">
                <div class="search-bar">
                    <input type="text" class="search-input" id="portfolioSearch" placeholder="Enter company name (e.g., Reliance, TCS, Infosys)">
                    <input type="number" class="quantity-input" id="quantityInput" placeholder="Quantity" min="1" value="1">
                    <button class="btn" onclick="addToPortfolio()">Add to Portfolio</button>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="portfolioChart"></canvas>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Company</th>
                            <th>Price (‚Çπ)</th>
                            <th>Quantity</th>
                            <th>Total Value (‚Çπ)</th>
                            <th>% of Portfolio</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="portfolioTable">
                        <tr>
                            <td colspan="6" class="empty-state">
                                <div class="empty-state-icon">üíº</div>
                                <p>No stocks in portfolio. Add stocks to start building your portfolio.</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-content" id="announcements">
            <div id="announcementsList">
                <div class="empty-state">
                    <div class="empty-state-icon">üì¢</div>
                    <p>No announcements available. Add stocks to your watchlist to see relevant announcements.</p>
                </div>
            </div>
        </div>

        <div class="tab-content" id="deepdive">
            <div class="deepdive-layout">
                <!-- Left Panel: Stock selector + document sources -->
                <div class="deepdive-sidebar">
                    <div class="deepdive-section">
                        <label class="deepdive-label">Select Company</label>
                        <select id="ddStockSelect" class="deepdive-select">
                            <option value="">-- Choose from watchlist --</option>
                        </select>
                    </div>

                    <div class="deepdive-section" id="ddSourcesPanel" style="display:none;">
                        <label class="deepdive-label">üìÇ Document Sources</label>
                        <div class="deepdive-sources" id="ddSources">
                            <div class="dd-loading">Fetching documents...</div>
                        </div>
                        <button class="btn" id="ddLoadBtn" onclick="loadDeepDiveDocuments()" style="width:100%;margin-top:0.8rem;font-size:0.9rem;">
                            üîÑ Refresh Documents
                        </button>
                    </div>

                    <div class="deepdive-section" id="ddContextPanel" style="display:none;">
                        <label class="deepdive-label">üìä Loaded Context</label>
                        <div id="ddContextStats" class="dd-context-stats"></div>
                    </div>
                </div>

                <!-- Right Panel: AI Chat -->
                <div class="deepdive-chat">
                    <div class="deepdive-chat-header">
                        <div id="ddChatTitle" style="font-weight:600;color:var(--text-primary);">Select a company to begin</div>
                        <div id="ddChatStatus" style="font-size:0.8rem;color:var(--text-secondary);">No documents loaded</div>
                    </div>

                    <div class="deepdive-messages" id="ddMessages">
                        <div class="dd-welcome">
                            <div style="font-size:3rem;margin-bottom:1rem;">üî¨</div>
                            <div style="font-size:1.2rem;font-weight:600;color:var(--text-primary);margin-bottom:0.5rem;">Deep Dive AI Analyst</div>
                            <div style="color:var(--text-secondary);font-size:0.95rem;line-height:1.6;">
                                Select a company from your watchlist, load its annual reports and earnings transcripts, then ask anything:
                            </div>
                            <div class="dd-suggestions">
                                <div class="dd-suggestion" onclick="ddAskSuggestion(this)">What is the revenue growth trend over 5 years?</div>
                                <div class="dd-suggestion" onclick="ddAskSuggestion(this)">What are the key risks mentioned in the annual report?</div>
                                <div class="dd-suggestion" onclick="ddAskSuggestion(this)">Summarize the latest quarterly earnings call</div>
                                <div class="dd-suggestion" onclick="ddAskSuggestion(this)">What is management's guidance for next year?</div>
                                <div class="dd-suggestion" onclick="ddAskSuggestion(this)">Compare margins across the last 4 quarters</div>
                                <div class="dd-suggestion" onclick="ddAskSuggestion(this)">What are the main business segments and their performance?</div>
                            </div>
                        </div>
                    </div>

                    <div class="deepdive-input-area">
                        <textarea id="ddQuestion" class="deepdive-textarea" 
                            placeholder="Ask anything about this company's financials, strategy, risks..."
                            onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();askDeepDive();}"></textarea>
                        <button class="dd-send-btn" onclick="askDeepDive()" id="ddSendBtn">
                            <span id="ddSendIcon">‚û§</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="update-indicator" id="updateIndicator" style="display: none;">
        <div class="loading"></div>
        <span>Updating prices...</span>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

    <script>

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // AUTHENTICATION CHECK
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        const WATCHLIST_KEY = 'stockTracker_watchlist';
        const PORTFOLIO_KEY = 'stockTracker_portfolio';
        let watchlist = [];
        let portfolio = [];
        let updateInterval;
        let chartInstance = null;

        async function init() {
            // Check if backend is running
            checkBackend();
            
            await loadFromStorage(); // Wait for data to load from database
            renderWatchlist();
            renderPortfolio();
            updatePrices();
            startAutoUpdate();
        }

        async function loadFromStorage() {
            // Load watchlist from database
            try {
                const watchlistResponse = await fetch(API_URL + '/watchlist', {
                    credentials: 'include'
                });
                if (watchlistResponse.ok) {
                    watchlist = await watchlistResponse.json();
                    console.log('Loaded watchlist from database:', watchlist);
                }
            } catch (error) {
                console.error('Error loading watchlist:', error);
                watchlist = [];
            }
            
            // Load portfolio from database
            try {
                const portfolioResponse = await fetch(API_URL + '/portfolio', {
                    credentials: 'include'
                });
                if (portfolioResponse.ok) {
                    portfolio = await portfolioResponse.json();
                    console.log('Loaded portfolio from database:', portfolio);
                }
            } catch (error) {
                console.error('Error loading portfolio:', error);
                portfolio = [];
            }
        }

        function saveToStorage() {
            // No longer needed - data is saved to database via API calls
            console.log('Data auto-saved to database');
        }

        function switchTab(index) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach((tab, i) => {
                if (i === index) {
                    tab.classList.add('active');
                    contents[i].classList.add('active');
                } else {
                    tab.classList.remove('active');
                    contents[i].classList.remove('active');
                }
            });
            
            if (index === 1) updatePortfolioChart();
            if (index === 2) updateAnnouncements();
            if (index === 3) initDeepDive();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  DEEP DIVE - CLEAN & SIMPLE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let ddContext = '';
        let ddCompany = '';
        let ddSymbol = '';
        let ddChatHistory = [];
        let ddDocuments = { annual: [], concalls: [], presentations: [] };
        let ddInitialized = false;

        function initDeepDive() {
            if (ddInitialized) return;
            ddInitialized = true;
            populateDDStockSelect();
        }

        function populateDDStockSelect() {
            const sel = document.getElementById('ddStockSelect');
            sel.innerHTML = '<option value="">-- Choose from watchlist --</option>';
            watchlist.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.symbol;
                opt.textContent = s.name;
                sel.appendChild(opt);
            });
            sel.onchange = onDDStockSelected;
        }

        async function onDDStockSelected() {
            const sel = document.getElementById('ddStockSelect');
            ddSymbol = sel.value;
            ddCompany = sel.options[sel.selectedIndex]?.text || '';
            if (!ddSymbol) return;

            document.getElementById('ddSourcesPanel').style.display = 'block';
            document.getElementById('ddContextPanel').style.display = 'none';
            document.getElementById('ddChatTitle').textContent = ddCompany;
            document.getElementById('ddChatStatus').textContent = 'Loading documents...';
            
            // Disable AI input until documents are read
            document.getElementById('ddQuestion').disabled = true;
            document.getElementById('ddSendBtn').disabled = true;
            document.getElementById('ddQuestion').placeholder = 'Select documents to read first...';
            
            // Clear chat completely
            ddContext = '';
            ddChatHistory = [];
            ddDocuments = { annual: [], concalls: [], presentations: [] };
            
            // Clear visible chat messages
            const chatContainer = document.getElementById('ddMessages');
            if (chatContainer) {
                chatContainer.innerHTML = '';
            }

            await loadDeepDiveDocuments();
        }

        async function loadDeepDiveDocuments() {
            if (!ddSymbol) return;
            
            const base = ddSymbol.replace('.NS', '').replace('.BO', '');
            const sourcesDiv = document.getElementById('ddSources');
            
            // Show loading
            sourcesDiv.innerHTML = `
                <div style="text-align:center;padding:3rem;color:var(--text-secondary);">
                    <div class="loading" style="margin:0 auto 1rem;"></div>
                    <p>Fetching documents...</p>
                </div>
            `;
            
            try {
                const { host: proxyHost, port: proxyPort } = parseProxy();
                
                const resp = await fetch(`${API_URL}/deepdive/screener`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        base_symbol: base,
                        company: ddCompany,
                        proxy_host: proxyHost,
                        proxy_port: proxyPort
                    })
                });
                
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                
                const data = await resp.json();
                console.log('Deep Dive response:', data);
                
                if (data.error) throw new Error(data.error);
                
                ddDocuments.annual = data.annual_reports || [];
                ddDocuments.concalls = data.concalls || [];
                ddDocuments.presentations = data.presentations || [];
                
                // Build context for AI
                ddContext = `Company: ${ddCompany} (${base})\n\n`;
                
                if (ddDocuments.annual.length > 0) {
                    ddContext += `=== Annual Reports (${ddDocuments.annual.length}) ===\n`;
                    ddDocuments.annual.forEach(doc => {
                        ddContext += `- ${doc.title} (${doc.year}): ${doc.url}\n`;
                    });
                    ddContext += '\n';
                }
                
                if (ddDocuments.concalls.length > 0) {
                    ddContext += `=== Concall Transcripts (${ddDocuments.concalls.length}) ===\n`;
                    ddDocuments.concalls.forEach(doc => {
                        ddContext += `- ${doc.quarter} (${doc.date}): ${doc.title}\n`;
                    });
                }

                if (ddDocuments.presentations.length > 0) {
                    ddContext += `\n=== Investor Presentation ===\n`;
                    ddDocuments.presentations.forEach(doc => {
                        ddContext += `- ${doc.title} (${doc.date}): ${doc.url}\n`;
                    });
                }
                
                // Render documents
                renderDocuments(data);
                
                // Update status
                const totalDocs = ddDocuments.annual.length + ddDocuments.concalls.length + ddDocuments.presentations.length;
                document.getElementById('ddChatStatus').textContent = 
                    totalDocs > 0 ? `Fetching document content...` : 'No documents found';
                
                if (totalDocs > 0) {
                    document.getElementById('ddContextPanel').style.display = 'block';
                    document.getElementById('ddContextStats').innerHTML = `
                        Documents loaded: <span>${totalDocs}</span><br>
                        Annual Reports: <span>${ddDocuments.annual.length}</span><br>
                        Concall Transcripts: <span>${ddDocuments.concalls.length}</span><br>
                        Presentations: <span>${ddDocuments.presentations.length}</span><br>
                        Company: <span>${ddCompany}</span>
                    `;
                    
                    // Update status to tell user to select and read documents
                    document.getElementById('ddChatStatus').textContent = 'Select documents and click "Read Selected Documents"';
                    
                    // Don't auto-fetch - let user select documents first
                    ddAddSystemMessage(`Documents loaded for **${ddCompany}**. Select which documents to read below, then click "Read Selected Documents".`);
                } else {
                    ddAddSystemMessage(`Couldn't load documents for **${ddCompany}**. Try asking questions using my general knowledge.`);
                }
                
            } catch (error) {
                console.error('Deep Dive error:', error);
                sourcesDiv.innerHTML = `
                    <div style="text-align:center;padding:3rem;color:#ff6b6b;">
                        <div style="font-size:2rem;margin-bottom:1rem;">‚ö†Ô∏è</div>
                        <p><strong>Error loading documents</strong></p>
                        <p style="font-size:0.9rem;color:var(--text-secondary);margin-top:0.5rem;">${error.message}</p>
                    </div>
                `;
                document.getElementById('ddChatStatus').textContent = `Error: ${error.message}`;
            }
        }

        function toggleAllDocs(type, checked) {
            document.querySelectorAll(`.${type}-checkbox`).forEach(cb => cb.checked = checked);
        }

        async function fetchDocumentText() {
            try {
                const { host: proxyHost, port: proxyPort } = parseProxy();
                
                // Get only SELECTED documents based on checkboxes
                const docsToFetch = [];
                
                // Get selected annual reports
                document.querySelectorAll('.annual-checkbox:checked').forEach(cb => {
                    const idx = parseInt(cb.dataset.index);
                    const doc = ddDocuments.annual[idx];
                    if (doc && !doc.title.toUpperCase().includes('DRHP')) {
                        docsToFetch.push({
                            url: doc.url,
                            title: doc.title,
                            type: 'annual'
                        });
                    }
                });
                
                // Get selected concall transcripts
                document.querySelectorAll('.concall-checkbox:checked').forEach(cb => {
                    const idx = parseInt(cb.dataset.index);
                    const doc = ddDocuments.concalls[idx];
                    if (doc && !doc.title.toUpperCase().includes('REC')) {
                        docsToFetch.push({
                            url: doc.url,
                            title: doc.quarter || doc.title,
                            type: 'concall'
                        });
                    }
                });
                
                // Get selected presentations
                document.querySelectorAll('.presentation-checkbox:checked').forEach(cb => {
                    const idx = parseInt(cb.dataset.index);
                    const doc = ddDocuments.presentations[idx];
                    if (doc) {
                        docsToFetch.push({
                            url: doc.url,
                            title: doc.title,
                            type: 'presentation'
                        });
                    }
                });
                
                if (docsToFetch.length === 0) {
                    document.getElementById('ddChatStatus').textContent = 'No documents to fetch';
                    return;
                }
                
                document.getElementById('ddChatStatus').textContent = `Reading ${docsToFetch.length} documents...`;
                
                // Fetch document text
                const resp = await fetch(`${API_URL}/deepdive/fetch-docs`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        docs: docsToFetch,
                        proxy_host: proxyHost,
                        proxy_port: proxyPort
                    })
                });
                
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                
                const data = await resp.json();
                console.log('Fetched documents:', data);
                
                // Build context from document text
                ddContext = `Company: ${ddCompany}\n\n`;
                
                let successCount = 0;
                let failCount = 0;
                let failedDocs = [];
                
                data.docs.forEach(doc => {
                    if (doc.text && doc.text.length > 100) {
                        ddContext += `\n=== ${doc.title} ===\n${doc.text}\n`;
                        successCount++;
                        console.log(`‚úì Extracted: ${doc.title} (${doc.text.length} chars)`);
                    } else {
                        failCount++;
                        failedDocs.push(`${doc.title} - ${doc.error || 'Unknown error'}`);
                        console.error(`‚úó Failed: ${doc.title}`, doc.error || 'No text extracted');
                    }
                });
                
                console.log(`\nüìä Summary: ${successCount}/${data.docs.length} documents extracted successfully`);
                if (failedDocs.length > 0) {
                    console.error('Failed documents:', failedDocs);
                }
                
                document.getElementById('ddChatStatus').textContent = 
                    `${successCount} of ${data.docs.length} documents ready - ask anything!`;
                
                // Enable AI input
                document.getElementById('ddQuestion').disabled = false;
                document.getElementById('ddSendBtn').disabled = false;
                document.getElementById('ddQuestion').placeholder = 'Ask anything about this company\'s financials, strategy, risks...';
                
                let statusMsg = `I've read **${successCount} of ${data.docs.length} documents** for **${ddCompany}**.`;
                if (failCount > 0) {
                    statusMsg += ` (${failCount} documents couldn't be processed)`;
                }
                statusMsg += ` Ask me anything about the company!`;
                
                ddAddSystemMessage(statusMsg);
                
            } catch (error) {
                console.error('Fetch docs error:', error);
                document.getElementById('ddChatStatus').textContent = `Error fetching documents: ${error.message}`;
                ddAddSystemMessage(`Could not fetch document text. I can still answer questions using my general knowledge.`);
            }
        }

        function renderDocuments(data) {
            const sourcesDiv = document.getElementById('ddSources');
            const { annual_reports = [], concalls = [], presentations = [], fallback_links = {} } = data;
            
            let html = '';
            
            // Annual Reports Section
            html += `
                <div style="margin-bottom:2rem;">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;">
                        <h3 style="margin:0;color:var(--text-primary);font-size:1.1rem;">
                            <input type="checkbox" id="selectAllAnnual" onchange="toggleAllDocs('annual', this.checked)" style="margin-right:0.5rem;" checked>
                            üìÑ Annual Reports
                        </h3>
                    </div>
            `;
            
            if (annual_reports.length > 0) {
                annual_reports.forEach((doc, idx) => {
                    const cleanTitle = (doc.title || '')
                        .replace(/\s*from\s+bse\s*/i, '')
                        .replace(/\s*from\s+nse\s*/i, '')
                        .replace(/\s*from\s+screener\s*/i, '')
                        .trim();
                    html += `
                        <div class="dd-source-item loaded" style="margin-bottom:0.5rem;">
                            <input type="checkbox" class="doc-checkbox annual-checkbox" data-type="annual" data-index="${idx}" checked style="margin-right:0.5rem;">
                            <span class="dd-source-icon">üìÑ</span>
                            <div style="flex:1;min-width:0;">
                                <div class="dd-source-name">${cleanTitle}</div>
                                <div style="font-size:0.75rem;color:var(--text-secondary);margin-top:0.2rem;">
                                    Source: ${doc.source}
                                </div>
                            </div>
                            <div style="display:flex;gap:0.3rem;align-items:center;">
                                <a href="${doc.url}" target="_blank" rel="noopener noreferrer" 
                                   class="dd-view-btn" title="Open PDF">üîó</a>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += `
                    <div style="padding:1rem;text-align:center;color:var(--text-secondary);font-size:0.9rem;
                                background:var(--bg-tertiary);border-radius:8px;">
                        No annual reports found via API
                    </div>
                `;
            }
            
            html += `</div>`;
            
            // Concall Transcripts Section
            html += `
                <div style="margin-bottom:2rem;">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;">
                        <h3 style="margin:0;color:var(--text-primary);font-size:1.1rem;">
                            <input type="checkbox" id="selectAllConcall" onchange="toggleAllDocs('concall', this.checked)" style="margin-right:0.5rem;" checked>
                            üéôÔ∏è Earnings Call Transcripts
                        </h3>
                    </div>
            `;
            
            if (concalls.length > 0) {
                concalls.forEach((doc, idx) => {
                    // Use quarter label if available, otherwise derive from date or title
                    let label = (doc.quarter || '').trim();
                    if (!label && doc.date) {
                        // Format date as "Mon YYYY" e.g. "Feb 2026"
                        const d = new Date(doc.date);
                        if (!isNaN(d)) {
                            label = d.toLocaleDateString('en-IN', { month: 'short', year: 'numeric' });
                        } else {
                            label = doc.date;
                        }
                    }
                    if (!label) label = `Transcript ${idx + 1}`;
                    html += `
                        <div class="dd-source-item loaded" style="margin-bottom:0.5rem;">
                            <input type="checkbox" class="doc-checkbox concall-checkbox" data-type="concall" data-index="${idx}" checked style="margin-right:0.5rem;">
                            <span class="dd-source-icon">üéôÔ∏è</span>
                            <div style="flex:1;min-width:0;">
                                <div class="dd-source-name">${label}</div>
                                <div style="font-size:0.75rem;color:var(--text-secondary);margin-top:0.2rem;">
                                    ${doc.date}
                                </div>
                            </div>
                            <div style="display:flex;gap:0.3rem;align-items:center;">
                                <a href="${doc.url}" target="_blank" rel="noopener noreferrer" 
                                   class="dd-view-btn" title="Open PDF">üîó</a>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += `
                    <div style="padding:1rem;text-align:center;color:var(--text-secondary);font-size:0.9rem;
                                background:var(--bg-tertiary);border-radius:8px;">
                        No concall transcripts found via API
                    </div>
                `;
            }
            
            html += `</div>`;

            // Investor Presentation Section
            html += `
                <div style="margin-bottom:2rem;">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;">
                        <h3 style="margin:0;color:var(--text-primary);font-size:1.1rem;">üìä Investor Presentation</h3>
                    </div>
            `;

            if (presentations.length > 0) {
                presentations.forEach((doc, idx) => {
                    // Shorten long BSE announcement titles to a clean label
                    let presTitle = 'Investor Presentation';
                    if (doc.date) presTitle += ` ‚Äì ${doc.date}`;
                    html += `
                        <div class="dd-source-item loaded" style="margin-bottom:0.5rem;">
                            <input type="checkbox" class="doc-checkbox presentation-checkbox" data-type="presentation" data-index="${idx}" checked style="margin-right:0.5rem;">
                            <span class="dd-source-icon">üìä</span>
                            <div style="flex:1;min-width:0;">
                                <div class="dd-source-name">${presTitle}</div>
                                <div style="font-size:0.75rem;color:var(--text-secondary);margin-top:0.2rem;">
                                    Source: ${doc.source}
                                </div>
                            </div>
                            <div style="display:flex;gap:0.3rem;align-items:center;">
                                <a href="${doc.url}" target="_blank" rel="noopener noreferrer"
                                   class="dd-view-btn" title="Open PDF">üîó</a>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += `
                    <div style="padding:1rem;text-align:center;color:var(--text-secondary);font-size:0.9rem;
                                background:var(--bg-tertiary);border-radius:8px;">
                        No investor presentation found
                    </div>
                `;
            }

            html += `</div>`;
            
            // Add "Read Selected Documents" button
            html += `
                <div style="margin-top:2rem;text-align:center;">
                    <button onclick="fetchDocumentText()" class="btn" style="width:100%;padding:1rem;font-size:1rem;font-weight:600;">
                        üìñ Read Selected Documents
                    </button>
                </div>
            `;

            sourcesDiv.innerHTML = html;
        }

        function ddAskSuggestion(el) {
            document.getElementById('ddQuestion').value = el.textContent;
            askDeepDive();
        }

        async function askDeepDive() {
            const input = document.getElementById('ddQuestion');
            const question = input.value.trim();
            if (!question) return;

            const btn = document.getElementById('ddSendBtn');
            btn.disabled = true;
            input.value = '';

            ddAppendMessage('user', question);
            ddChatHistory.push({ role: 'user', content: question });

            const typingId = ddShowTyping();

            try {
                const { host: proxyHost, port: proxyPort } = parseProxy();

                const resp = await fetch(`${API_URL}/deepdive/ask`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question: question,
                        context: ddContext,
                        messages: ddChatHistory.slice(0, -1), // Exclude current question
                        proxy_host: proxyHost,
                        proxy_port: proxyPort
                    })
                });

                ddRemoveTyping(typingId);

                if (resp.ok) {
                    const data = await resp.json();
                    const answer = data.answer || 'No response received.';
                    ddAppendMessage('ai', answer);
                    ddChatHistory.push({ role: 'assistant', content: answer });
                } else {
                    const errorData = await resp.json().catch(() => ({}));
                    ddAppendMessage('ai', `‚ö†Ô∏è Error: ${errorData.error || 'Unknown error'}`);
                }
            } catch(e) {
                ddRemoveTyping(typingId);
                ddAppendMessage('ai', `‚ö†Ô∏è Connection error: ${e.message}`);
            }

            btn.disabled = false;
        }

        function ddAppendMessage(role, text) {
            const msgs = document.getElementById('ddMessages');
            const welcome = msgs.querySelector('.dd-welcome');
            if (welcome) welcome.remove();

            const div = document.createElement('div');
            div.className = `dd-message ${role}`;
            div.innerHTML = `
                <div class="dd-avatar">${role === 'user' ? 'üë§' : 'ü§ñ'}</div>
                <div class="dd-bubble">${ddFormatText(text)}</div>
            `;
            msgs.appendChild(div);
            msgs.scrollTop = msgs.scrollHeight;
        }

        function ddAddSystemMessage(text) {
            const msgs = document.getElementById('ddMessages');
            const welcome = msgs.querySelector('.dd-welcome');
            if (welcome) welcome.remove();
            const div = document.createElement('div');
            div.className = 'dd-message ai';
            div.innerHTML = `
                <div class="dd-avatar">ü§ñ</div>
                <div class="dd-bubble">${ddFormatText(text)}</div>
            `;
            msgs.appendChild(div);
            msgs.scrollTop = msgs.scrollHeight;
        }

        function ddShowTyping() {
            const msgs = document.getElementById('ddMessages');
            const id = 'ddtyping-' + Date.now();
            const div = document.createElement('div');
            div.className = 'dd-message ai';
            div.id = id;
            div.innerHTML = `
                <div class="dd-avatar">ü§ñ</div>
                <div class="dd-bubble">
                    <div class="dd-typing"><span></span><span></span><span></span></div>
                </div>
            `;
            msgs.appendChild(div);
            msgs.scrollTop = msgs.scrollHeight;
            return id;
        }

        function ddRemoveTyping(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function ddFormatText(text) {
            return text
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/^### (.+)$/gm, '<div style="font-weight:700;margin:0.5rem 0 0.2rem;color:var(--accent-primary);">$1</div>')
                .replace(/^## (.+)$/gm,  '<div style="font-weight:700;margin:0.5rem 0 0.2rem;font-size:1.05em;">$1</div>')
                .replace(/^- (.+)$/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>\n?)+/g, s => `<ul>${s}</ul>`)
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                .replace(/^(.+)$/, '<p>$1</p>');
        }

        // Backend API URL
        // Auto-detect API URL (works both locally and on Render)
        const API_URL = window.location.origin + '/api';

        // ‚îÄ‚îÄ Proxy helpers (no proxy needed on Render ‚Äî always returns empty) ‚îÄ‚îÄ
        function parseProxy() {
            const host = localStorage.getItem('proxyHost') || '';
            const port = localStorage.getItem('proxyPort') || '';
            return { host, port };
        }
        function saveProxySettings() {
            const host = document.getElementById('proxyHostInput');
            const port = document.getElementById('proxyPortInput');
            if (host) localStorage.setItem('proxyHost', host.value.trim());
            if (port) localStorage.setItem('proxyPort', port.value.trim());
        }
        function loadProxySettings() {
            const host = document.getElementById('proxyHostInput');
            const port = document.getElementById('proxyPortInput');
            if (host) host.value = localStorage.getItem('proxyHost') || '';
            if (port) port.value = localStorage.getItem('proxyPort') || '';
        }
		
		// Authentication check - redirect to login if not authenticated
    (async function() {
        try {
            const response = await fetch(API_URL + '/auth/check', { credentials: 'include' });
            const data = await response.json();
            
            if (!data.authenticated) {
                window.location.href = '/login.html';
                return;
            }
            
            // Add username and logout button
            const body = document.body;
            const userInfo = document.createElement('div');
            userInfo.style.cssText = 'position:fixed;top:1rem;right:1rem;display:flex;align-items:center;gap:1rem;z-index:9999;background:rgba(0,0,0,0.5);padding:0.5rem 1rem;border-radius:8px;';
            userInfo.innerHTML = `
                <span style="color:white;font-weight:500;">üë§ ${data.username}</span>
                <button onclick="logout()" style="padding:0.5rem 1rem;background:#ff4444;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:500;">
                    Logout
                </button>
            `;
            body.insertBefore(userInfo, body.firstChild);
        } catch (error) {
            console.error('Auth check failed:', error);
            window.location.href = '/login.html';
        }
    })();
    
    async function logout() {
        try {
            await fetch(API_URL + '/auth/logout', { method: 'POST', credentials: 'include' });
        } catch (error) {
            console.error('Logout error:', error);
        }
        window.location.href = '/login.html';
    }

        // Check if backend is running
        async function checkBackend() {
            try {
                const response = await fetch(`${API_URL}/health`);
                if (response.ok) {
                    console.log('‚úì Backend server is running');
                    return true;
                }
            } catch (error) {
                console.error('‚úó Backend server is NOT running!');
                console.error('Please run: python stock_backend.py');
                return false;
            }
        }

        // Search for Indian stocks using backend API
        async function searchIndiaStocks(query) {
            try {
                console.log('Searching for:', query);
                const url = `${API_URL}/search?q=${encodeURIComponent(query)}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    console.error('Search failed with status:', response.status);
                    const errorData = await response.json();
                    console.error('Error details:', errorData);
                    alert(`Search failed: ${errorData.error || 'Unknown error'}\n\nMake sure backend is running:\npython stock_backend.py`);
                    return [];
                }
                
                const data = await response.json();
                console.log('Search results:', data.results);
                return data.results || [];
            } catch (error) {
                console.error('Search error:', error);
                alert('‚ùå Cannot connect to backend server!\n\nPlease make sure the Python backend is running:\n\n1. Open terminal/command prompt\n2. Run: python stock_backend.py\n3. Wait for "Server starting on http://localhost:5000"\n4. Then try again');
                return [];
            }
        }

        // Fetch stock price using backend API
        async function fetchStockPrice(symbol) {
            try {
                console.log('Fetching price for:', symbol);
                // Try /api/quote first
                const url = `${API_URL}/quote?symbol=${encodeURIComponent(symbol)}`;
                const response = await fetch(url, { credentials: 'include' });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.price && data.price > 0) {
                        console.log('Price data:', data);
                        return { price: data.price, change: data.change,
                                 changePercent: data.changePercent, volume: data.volume };
                    }
                }

                // Fallback: try watchlist endpoint price for same symbol
                const wlResp = await fetch(`${API_URL}/watchlist`, { credentials: 'include' });
                if (wlResp.ok) {
                    const wl = await wlResp.json();
                    const match = wl.find(s => s.symbol === symbol);
                    if (match && match.price > 0) return { price: match.price, change: match.change,
                                                            changePercent: match.changePercent, volume: match.volume };
                }

                return null;
            } catch (error) {
                console.error('Price fetch error:', error);
                return null;
            }
        }

        async function addToWatchlist() {
            const input = document.getElementById('watchlistSearch');
            const query = input.value.trim();
            
            if (!query) {
                alert('Please enter a company name');
                return;
            }
            
            document.getElementById('updateIndicator').style.display = 'flex';
            document.getElementById('updateIndicator').innerHTML = '<div class="loading"></div><span>Searching for stocks...</span>';
            
            const results = await searchIndiaStocks(query);
            
            document.getElementById('updateIndicator').style.display = 'none';
            
            if (results.length === 0) {
                alert('Stock not found. Try: Reliance, TCS, Infosys, HDFC Bank');
                return;
            }
            
            // If multiple results, show selection dialog
            let selectedStock;
            if (results.length > 1) {
                selectedStock = await showStockSelectionDialog(results, 'watchlist');
                if (!selectedStock) return; // User cancelled
            } else {
                selectedStock = results[0];
            }
            
            if (watchlist.find(s => s.symbol === selectedStock.symbol)) {
                alert('Stock already in watchlist');
                return;
            }
            
            document.getElementById('updateIndicator').style.display = 'flex';
            document.getElementById('updateIndicator').innerHTML = '<div class="loading"></div><span>Adding to watchlist...</span>';
            
            // Add to database
            try {
                const response = await fetch(API_URL + '/watchlist/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        symbol: selectedStock.symbol,
                        name: selectedStock.name
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Reload watchlist from database
                    await loadFromStorage();
                    renderWatchlist();
                    
                    // Refresh Deep Dive dropdown if initialized
                    if (typeof ddInitialized !== 'undefined' && ddInitialized) {
                        populateDDStockSelect();
                    }
                    
                    input.value = '';
                } else {
                    alert(result.message || 'Failed to add to watchlist');
                }
            } catch (error) {
                console.error('Error adding to watchlist:', error);
                alert('Error adding to watchlist');
            }
            
            document.getElementById('updateIndicator').style.display = 'none';
        }

        async function showStockSelectionDialog(results, type) {
            return new Promise((resolve) => {
                // Create modal overlay
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;
                
                // Create dialog
                const dialog = document.createElement('div');
                dialog.style.cssText = `
                    background: var(--bg-secondary);
                    border-radius: 12px;
                    padding: 2rem;
                    max-width: 600px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                    border: 1px solid var(--border-color);
                `;
                
                dialog.innerHTML = `
                    <h2 style="color: var(--text-primary); margin-bottom: 1rem; font-size: 1.5rem;">Select Stock</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Multiple stocks found. Please select the correct one:</p>
                    <div id="stockResults"></div>
                    <button id="cancelBtn" class="btn btn-danger" style="margin-top: 1.5rem; width: 100%;">Cancel</button>
                `;
                
                const resultsContainer = dialog.querySelector('#stockResults');
                
                results.forEach((stock, index) => {
                    const stockItem = document.createElement('div');
                    stockItem.style.cssText = `
                        background: var(--bg-tertiary);
                        border: 2px solid var(--border-color);
                        border-radius: 8px;
                        padding: 1.5rem;
                        margin-bottom: 1rem;
                        cursor: pointer;
                        transition: all 0.3s;
                    `;
                    
                    const exchange = stock.symbol.endsWith('.NS') ? 'NSE (National Stock Exchange)' : 
                                   stock.symbol.endsWith('.BO') ? 'BSE (Bombay Stock Exchange)' : 'Other';
                    
                    stockItem.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                            <div>
                                <div style="color: var(--text-primary); font-weight: 600; font-size: 1.1rem;">${stock.name}</div>
                                <div style="color: var(--accent-primary); font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; margin-top: 0.3rem;">${stock.symbol}</div>
                            </div>
                            <div style="background: var(--accent-primary); color: var(--bg-primary); padding: 0.3rem 0.8rem; border-radius: 6px; font-size: 0.85rem; font-weight: 600;">
                                ${exchange}
                            </div>
                        </div>
                    `;
                    
                    stockItem.addEventListener('mouseenter', () => {
                        stockItem.style.borderColor = 'var(--accent-primary)';
                        stockItem.style.transform = 'translateX(5px)';
                    });
                    
                    stockItem.addEventListener('mouseleave', () => {
                        stockItem.style.borderColor = 'var(--border-color)';
                        stockItem.style.transform = 'translateX(0)';
                    });
                    
                    stockItem.addEventListener('click', () => {
                        document.body.removeChild(overlay);
                        resolve(stock);
                    });
                    
                    resultsContainer.appendChild(stockItem);
                });
                
                dialog.querySelector('#cancelBtn').addEventListener('click', () => {
                    document.body.removeChild(overlay);
                    resolve(null);
                });
                
                overlay.appendChild(dialog);
                document.body.appendChild(overlay);
            });
        }

        async function removeFromWatchlist(symbol) {
            try {
                const response = await fetch(API_URL + '/watchlist/remove', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ symbol })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Reload watchlist from database
                    await loadFromStorage();
                    renderWatchlist();
                    
                    // Refresh Deep Dive dropdown if initialized
                    if (typeof ddInitialized !== 'undefined' && ddInitialized) {
                        populateDDStockSelect();
                    }
                }
            } catch (error) {
                console.error('Error removing from watchlist:', error);
            }
        }

        function renderWatchlist() {
            const tbody = document.getElementById('watchlistTable');
            
            if (watchlist.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <div class="empty-state-icon">üìà</div>
                            <p>No stocks in watchlist. Add stocks to start tracking.</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = watchlist.map(stock => `
                <tr>
                    <td>
                        <div class="company-name">${stock.name}</div>
                    </td>
                    <td class="price">‚Çπ${stock.price.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td class="${stock.change >= 0 ? 'change-positive' : 'change-negative'}">
                        ${stock.change >= 0 ? '+' : ''}${stock.change.toFixed(2)}
                    </td>
                    <td>
                        <span class="badge ${stock.changePercent >= 0 ? 'badge-success' : 'badge-danger'}">
                            ${stock.changePercent >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(stock.changePercent).toFixed(2)}%
                        </span>
                    </td>
                    <td>${stock.volume.toLocaleString('en-IN')}</td>
                    <td>
                        <button class="btn btn-danger" style="padding: 0.5rem 1rem; font-size: 0.9rem;" onclick="removeFromWatchlist('${stock.symbol}')">Remove</button>
                    </td>
                </tr>
            `).join('');
        }

        async function addToPortfolio() {
            const input = document.getElementById('portfolioSearch');
            const quantityInput = document.getElementById('quantityInput');
            const query = input.value.trim();
            const quantity = parseInt(quantityInput.value);
            
            if (!query) {
                alert('Please enter a company name');
                return;
            }
            
            if (!quantity || quantity < 1) {
                alert('Please enter a valid quantity');
                return;
            }
            
            document.getElementById('updateIndicator').style.display = 'flex';
            document.getElementById('updateIndicator').innerHTML = '<div class="loading"></div><span>Searching for stocks...</span>';
            
            const results = await searchIndiaStocks(query);
            document.getElementById('updateIndicator').style.display = 'none';
            
            if (results.length === 0) {
                alert('Stock not found. Try: Reliance, TCS, Infosys, HDFC Bank');
                return;
            }
            
            // If multiple results, show selection dialog
            let selectedStock;
            if (results.length > 1) {
                selectedStock = await showStockSelectionDialog(results, 'portfolio');
                if (!selectedStock) return; // User cancelled
            } else {
                selectedStock = results[0];
            }
            
            document.getElementById('updateIndicator').style.display = 'flex';
            document.getElementById('updateIndicator').innerHTML = '<div class="loading"></div><span>Fetching price...</span>';
            
            const priceData = await fetchStockPrice(selectedStock.symbol);
            const buyPrice = priceData ? priceData.price : 0;
            
            // Don't block the add if price fetch fails ‚Äî price will update on next refresh
            if (!buyPrice) {
                console.warn('Price fetch failed for', selectedStock.symbol, '‚Äî adding with price 0, will update on refresh');
            }
            
            // Add to database
            try {
                const response = await fetch(API_URL + '/portfolio/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        symbol: selectedStock.symbol,
                        name: selectedStock.name,
                        quantity: quantity,
                        buy_price: buyPrice,
                        buy_date: new Date().toISOString().split('T')[0]
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Reload from database
                    await loadFromStorage();
                    renderPortfolio();
                    updatePortfolioChart();
                    input.value = '';
                    quantityInput.value = '1';
                } else {
                    alert(result.message || 'Failed to add to portfolio');
                }
            } catch (error) {
                console.error('Error adding to portfolio:', error);
                alert('Error adding to portfolio');
            }
            
            document.getElementById('updateIndicator').style.display = 'none';
        }

        async function removeFromPortfolio(holdingId) {
            try {
                const response = await fetch(API_URL + '/portfolio/remove', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ holding_id: holdingId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    await loadFromStorage();
                    renderPortfolio();
                    updatePortfolioChart();
                }
            } catch (error) {
                console.error('Error removing from portfolio:', error);
            }
        }

        function updateQuantity(symbol, newQuantity) {
            const stock = portfolio.find(s => s.symbol === symbol);
            if (stock) {
                stock.quantity = parseInt(newQuantity) || 1;
                stock.totalValue = stock.price * stock.quantity;
                saveToStorage();
                renderPortfolio();
                updatePortfolioChart();
            }
        }

        function renderPortfolio() {
            const tbody = document.getElementById('portfolioTable');
            
            if (portfolio.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <div class="empty-state-icon">üíº</div>
                            <p>No stocks in portfolio. Add stocks to start building your portfolio.</p>
                        </td>
                    </tr>
                `;
                updatePortfolioStats();
                return;
            }
            
            const totalPortfolioValue = portfolio.reduce((sum, stock) => {
                const cv = (stock.current_price || stock.price || 0) * (stock.quantity || 0);
                return sum + cv;
            }, 0);

            // Sort by current value descending
            const sortedPortfolio = [...portfolio].sort((a, b) => {
                const va = (a.current_price || a.price || 0) * (a.quantity || 0);
                const vb = (b.current_price || b.price || 0) * (b.quantity || 0);
                return vb - va;
            });
            
            tbody.innerHTML = sortedPortfolio.map(stock => {
                const currentValue = (stock.current_price || stock.price || 0) * (stock.quantity || 0);
                const investedValue = (stock.buy_price || stock.price || 0) * (stock.quantity || 0);
                const profitLoss = currentValue - investedValue;
                const profitLossPercent = investedValue > 0 ? (profitLoss / investedValue * 100) : 0;
                const profitLossClass = profitLoss >= 0 ? 'positive' : 'negative';
                
                const portfolioPct = totalPortfolioValue > 0 ? (currentValue / totalPortfolioValue * 100) : 0;
                return `
                    <tr>
                        <td>
                            <div class="company-name">${stock.name}</div>
                        </td>
                        <td class="price">‚Çπ${(stock.current_price || stock.price || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>${stock.quantity || 0}</td>
                        <td class="price">‚Çπ${currentValue.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>${portfolioPct.toFixed(2)}%</td>
                        <td>
                            <button class="btn btn-danger" style="padding: 0.5rem 1rem; font-size: 0.9rem;" onclick="removeFromPortfolio(${stock.id})">Remove</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            updatePortfolioStats();
        }

        function updatePortfolioStats() {
            const totalInvested = portfolio.reduce((sum, stock) => sum + ((stock.buy_price || 0) * (stock.quantity || 0)), 0);
            const totalCurrent = portfolio.reduce((sum, stock) => sum + ((stock.current_price || stock.price || 0) * (stock.quantity || 0)), 0);
            const totalProfitLoss = totalCurrent - totalInvested;
            const totalProfitLossPercent = totalInvested > 0 ? (totalProfitLoss / totalInvested * 100) : 0;
            const totalStocks = portfolio.length;
            
            document.getElementById('totalValue').textContent = `‚Çπ${totalCurrent.toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
            document.getElementById('totalStocks').textContent = totalStocks;
            
            // Update profit/loss if elements exist
            const plElement = document.getElementById('totalProfitLoss');
            if (plElement) {
                plElement.textContent = `‚Çπ${totalProfitLoss.toLocaleString('en-IN', {minimumFractionDigits: 2})} (${totalProfitLossPercent >= 0 ? '+' : ''}${totalProfitLossPercent.toFixed(2)}%)`;
                plElement.className = totalProfitLoss >= 0 ? 'positive' : 'negative';
            }
        }

        function updatePortfolioChart() {
            const canvas = document.getElementById('portfolioChart');
            const ctx = canvas.getContext('2d');
            
            if (portfolio.length === 0) {
                if (chartInstance) {
                    chartInstance.destroy();
                    chartInstance = null;
                }
                return;
            }
            
            const data = portfolio.map(stock => (stock.current_price || stock.price || 0) * (stock.quantity || 0));
            // Remove .NS and .BO from labels
            const labels = portfolio.map(stock => stock.symbol.replace('.NS', '').replace('.BO', ''));
            const colors = [
                '#00d4ff', '#7c3aed', '#10b981', '#f59e0b', 
                '#ef4444', '#ec4899', '#8b5cf6', '#06b6d4',
                '#14b8a6', '#f97316', '#84cc16', '#6366f1'
            ];
            
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            // Plugin to draw only percentages inside
            const percentagePlugin = {
                id: 'percentageLabels',
                afterDatasetDraw(chart) {
                    const ctx = chart.ctx;
                    const meta = chart.getDatasetMeta(0);
                    const total = chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                    
                    meta.data.forEach((arc, index) => {
                        const percentage = ((chart.data.datasets[0].data[index] / total) * 100).toFixed(1);
                        
                        // Get center point of the arc
                        const centerAngle = (arc.startAngle + arc.endAngle) / 2;
                        
                        // Calculate the radius for label placement
                        const innerRadius = (arc.innerRadius + arc.outerRadius) / 2;
                        const x = arc.x + Math.cos(centerAngle) * innerRadius;
                        const y = arc.y + Math.sin(centerAngle) * innerRadius;
                        
                        // Show percentage for all slices, adjust font size for very small ones
                        let fontSize = 16;
                        if (parseFloat(percentage) < 5) {
                            fontSize = 13;  // Smaller font for tiny slices
                        }
                        
                        ctx.save();
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillStyle = '#ffffff';
                        ctx.font = `bold ${fontSize}px Poppins`;
                        ctx.shadowColor = 'rgba(0, 0, 0, 0.9)';
                        ctx.shadowBlur = 8;
                        ctx.fillText(`${percentage}%`, x, y);
                        ctx.restore();
                    });
                }
            };
            
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderColor: '#1e2442',
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    layout: {
                        padding: 20
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#1e2442',
                            titleColor: '#ffffff',
                            bodyColor: '#a0aec0',
                            borderColor: '#2d3748',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ‚Çπ${value.toLocaleString('en-IN', {minimumFractionDigits: 2})} (${percentage}%)`;
                                }
                            }
                        }
                    }
                },
                plugins: [percentagePlugin]
            });
        }

        async function updatePrices() {
            if (watchlist.length === 0 && portfolio.length === 0) return;
            
            console.log('üîÑ Auto-refreshing prices...');
            document.getElementById('updateIndicator').style.display = 'flex';
            document.getElementById('updateIndicator').innerHTML = '<div class="loading"></div><span>Refreshing prices...</span>';
            
            try {
                // Reload watchlist and portfolio from database (backend fetches fresh prices)
                await loadFromStorage();
                
                // Re-render both
                renderWatchlist();
                renderPortfolio();
                updatePortfolioChart();
                
                console.log('‚úì Prices refreshed');
            } catch (error) {
                console.error('Update error:', error);
            } finally {
                document.getElementById('updateIndicator').style.display = 'none';
            }
        }

        let announcementInterval = null;
        let knownAnnouncementIds = new Set(); // tracks seen announcements
        let announcementsInitialized = false;

        function startAutoUpdate() {
            // Prices every 30 seconds
            updateInterval = setInterval(() => {
                updatePrices();
            }, 30000);

            // Announcements every 5 minutes
            announcementInterval = setInterval(() => {
                checkNewAnnouncements();
            }, 5 * 60 * 1000);
        }

        // Called on tab switch - renders without alerting
        async function updateAnnouncements() {
            await fetchAndRenderAnnouncements(false);
        }

        // Called by timer - silently checks for new ones and alerts
        async function checkNewAnnouncements() {
            await fetchAndRenderAnnouncements(true);
        }

        async function fetchAndRenderAnnouncements(alertOnNew) {
            const container = document.getElementById('announcementsList');

            if (watchlist.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¢</div>
                        <p>No announcements available. Add stocks to your watchlist to see relevant announcements.</p>
                    </div>
                `;
                return;
            }

            // Only show loading spinner on first load
            if (!announcementsInitialized) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="loading"></div>
                        <p style="margin-top:1rem;">Fetching corporate announcements from NSE...</p>
                    </div>
                `;
            }

            try {
                const symbols = watchlist.map(s => s.symbol);
                const { host: proxyHost, port: proxyPort } = parseProxy();

                const response = await fetch(`${API_URL}/announcements`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbols, proxy_host: proxyHost, proxy_port: proxyPort })
                });

                if (!response.ok) throw new Error('Failed to fetch announcements');

                let announcements = (await response.json()).announcements || [];

                // Sort newest first on frontend too
                const DATE_MONTHS = {
                    'jan':1,'feb':2,'mar':3,'apr':4,'may':5,'jun':6,
                    'jul':7,'aug':8,'sep':9,'oct':10,'nov':11,'dec':12
                };
                function parseAnnDate(s) {
                    if (!s) return 0;
                    s = s.trim();
                    const m = s.match(/(\d{1,2})-([A-Za-z]{3})-(\d{4})(?:\s+(\d{2}):(\d{2})(?::(\d{2}))?)?/);
                    if (m) {
                        const mon = DATE_MONTHS[m[2].toLowerCase()];
                        if (mon) return new Date(
                            parseInt(m[3]), mon-1, parseInt(m[1]),
                            parseInt(m[4]||0), parseInt(m[5]||0), parseInt(m[6]||0)
                        ).getTime();
                    }
                    const d = new Date(s);
                    return isNaN(d.getTime()) ? 0 : d.getTime();
                }
                announcements.sort((a, b) => parseAnnDate(b.date) - parseAnnDate(a.date));

                // ‚îÄ‚îÄ detect new announcements ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                const newOnes = [];
                announcements.forEach(ann => {
                    // unique ID = symbol + date + title
                    const id = `${ann.symbol}|${ann.date}|${ann.title}`;
                    if (!knownAnnouncementIds.has(id)) {
                        knownAnnouncementIds.add(id);
                        if (announcementsInitialized) newOnes.push(ann); // only alert after first load
                    }
                });

                announcementsInitialized = true;

                // ‚îÄ‚îÄ alert for new announcements ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                if (alertOnNew && newOnes.length > 0) {
                    showNewAnnouncementAlert(newOnes);
                }

                // ‚îÄ‚îÄ render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                if (announcements.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üì¢</div>
                            <p>No recent corporate announcements available.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = announcements.map(ann => {
                    const ms = parseAnnDate(ann.date);
                    let dateStr = ann.date || '';
                    if (ms > 0) {
                        const d = new Date(ms);
                        dateStr = d.toLocaleDateString('en-IN', { year:'numeric', month:'short', day:'numeric' });
                        const timePart = ann.date.match(/(\d{2}:\d{2})/);
                        if (timePart) dateStr += ' ' + timePart[1];
                    }
                    const id = `${ann.symbol}|${ann.date}|${ann.title}`;
                    const isNew = newOnes.some(n => `${n.symbol}|${n.date}|${n.title}` === id);

                    return `
                        <div class="announcement-item" ${isNew ? 'style="border-color: var(--accent-primary); background: rgba(0,212,255,0.05);"' : ''}>
                            <div class="announcement-header">
                                <div style="display:flex; align-items:center; gap:0.6rem;">
                                    ${isNew ? '<span style="background:var(--accent-primary);color:#000;font-size:0.7rem;font-weight:700;padding:0.2rem 0.5rem;border-radius:4px;">NEW</span>' : ''}
                                    <div>
                                        <div class="announcement-company">${ann.company}</div>
                                        <div class="stock-symbol">${ann.symbol.replace('.NS','').replace('.BO','')} ‚Ä¢ ${ann.exchange}</div>
                                    </div>
                                </div>
                                <div class="announcement-date">${dateStr}</div>
                            </div>
                            <div class="announcement-title">${ann.title}</div>
                            ${ann.category ? `<div style="margin-top:0.5rem;">
                                <span style="background:var(--bg-tertiary);color:var(--text-secondary);padding:0.2rem 0.6rem;border-radius:4px;font-size:0.8rem;">${ann.category}</span>
                            </div>` : ''}
                            ${ann.attachment_url ? `<div style="margin-top:0.5rem;">
                                <a href="${ann.attachment_url}" target="_blank" rel="noopener noreferrer"
                                   style="color:var(--accent-primary);font-size:0.85rem;text-decoration:none;">
                                   üìé View Document
                                </a>
                            </div>` : ''}
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Announcements error:', error);
                if (!announcementsInitialized) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">‚ö†Ô∏è</div>
                            <p>Unable to fetch announcements. Make sure the backend is running.</p>
                        </div>
                    `;
                }
            }
        }

        function showNewAnnouncementAlert(newOnes) {
            // Remove existing alert if any
            const existing = document.getElementById('announcementAlert');
            if (existing) existing.remove();

            const alert = document.createElement('div');
            alert.id = 'announcementAlert';
            alert.style.cssText = `
                position: fixed;
                top: 1.5rem;
                right: 1.5rem;
                background: var(--bg-secondary);
                border: 2px solid var(--accent-primary);
                border-radius: 12px;
                padding: 1.2rem 1.5rem;
                z-index: 99999;
                max-width: 380px;
                box-shadow: 0 8px 32px rgba(0,212,255,0.25);
                animation: slideIn 0.4s ease;
            `;

            const list = newOnes.slice(0, 3).map(a =>
                `<div style="margin-top:0.5rem;padding-top:0.5rem;border-top:1px solid var(--border-color);">
                    <div style="font-weight:600;color:var(--text-primary);font-size:0.9rem;">${a.company}</div>
                    <div style="color:var(--text-secondary);font-size:0.82rem;margin-top:0.2rem;">${a.title}</div>
                </div>`
            ).join('');

            const more = newOnes.length > 3
                ? `<div style="color:var(--accent-primary);font-size:0.82rem;margin-top:0.5rem;">+${newOnes.length - 3} more</div>` : '';

            alert.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.3rem;">
                    <div style="color:var(--accent-primary);font-weight:700;font-size:1rem;">
                        üîî ${newOnes.length} New Announcement${newOnes.length > 1 ? 's' : ''}
                    </div>
                    <button onclick="document.getElementById('announcementAlert').remove()"
                        style="background:none;border:none;color:var(--text-secondary);cursor:pointer;font-size:1.2rem;line-height:1;">‚úï</button>
                </div>
                ${list}${more}
                <button onclick="switchTab(2);document.getElementById('announcementAlert').remove();"
                    style="margin-top:1rem;width:100%;padding:0.6rem;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));
                    border:none;border-radius:8px;color:#fff;font-weight:600;cursor:pointer;font-size:0.9rem;">
                    View Announcements
                </button>
            `;

            document.body.appendChild(alert);

            // Auto-dismiss after 30 seconds
            setTimeout(() => { if (alert.parentNode) alert.remove(); }, 30000);
        }
        window.addEventListener('load', init);

        document.getElementById('proxyHostInput').addEventListener('change', saveProxySettings);
        document.getElementById('proxyPortInput').addEventListener('change', saveProxySettings);
    </script>
</body>
</html>
